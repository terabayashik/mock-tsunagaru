import{a,w as tn}from"./chunk-QMGIS6GS-npKyu-26.js";import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{u as nn,C as sn,b as dt,c as Lt,e as ut,I as rn,S as on,d as an,f as ln,g as cn,h as dn,i as un,j as hn,k as Rt}from"./ContentAddModal-C_1kSIvW.js";import{C as Mt,F as ke,e as at,G as $,S as ne,l as J,M as Oe,N as mn,I as ht,f as lt,h as vt,j as xn,L as _t,k as fn,m as gn}from"./layout-CG8-yu9n.js";import{c as pn,I as Nt,u as yn,T as c,P as Z,B as X,d as ze,A as it}from"./TextInput-DMku8_7E.js";import{l as ue,i as he,o as $e,q as Fe,x as Ot,U as jn,s as Be,B as w,v as $t,z as Ae,t as mt,F as bn,w as Cn,u as wn,G as Ye,C as de}from"./react-Bl1EszzN.js";import{a as xt}from"./get-contrast-color-B-kutpjz.js";import{g as ft}from"./get-auto-contrast-value-Da6zqqWm.js";import{I as vn,a as In,b as Sn,A as It,m as St,c as zn,L as kn}from"./LayoutFormModal-wNST5pET.js";import{u as An}from"./use-mantine-color-scheme-Bh-JJ2Z9.js";import{u as Ge,I as De,a as Dn,T as Q,b as Pn,p as En,c as Tn,d as Ln,m as Rn}from"./modal-DDjUobDH.js";import{c as Mn,a as gt}from"./createReactComponent-Bo4FKQF2.js";import{D as ct}from"./Divider-Dp5dI_5-.js";import{m as Ne}from"./events-CgSWVLLi.js";import{A as _n,I as Nn}from"./IconExclamationCircle-DgxA9N8q.js";import"./index-Bt7hW1Ho.js";const Ft=a.createContext(null),On=Ft.Provider,Bt=()=>a.useContext(Ft),[$n,Fn]=pn();var Yt={card:"m_26775b0a"};const Bn={withBorder:!0},Yn=Fe((t,{radius:n})=>({card:{"--card-radius":Be(n)}})),pt=ue((t,n)=>{const r=he("CheckboxCard",Bn,t),{classNames:i,className:h,style:o,styles:u,unstyled:s,vars:d,checked:y,mod:p,withBorder:I,value:m,onClick:f,defaultChecked:g,onChange:k,...j}=r,P=$e({name:"CheckboxCard",classes:Yt,props:r,className:h,style:o,classNames:i,styles:u,unstyled:s,vars:d,varsResolver:Yn,rootSelector:"card"}),S=Bt(),D=typeof y=="boolean"?y:S?S.value.includes(m||""):void 0,[A,v]=Ot({value:D,defaultValue:g,finalValue:!1,onChange:k});return e.jsx($n,{value:{checked:A},children:e.jsx(jn,{ref:n,mod:[{"with-border":I,checked:A},p],...P("card"),...j,role:"checkbox","aria-checked":A,onClick:O=>{f==null||f(O),S==null||S.onChange(m||""),v(!A)}})})});pt.displayName="@mantine/core/CheckboxCard";pt.classes=Yt;const Gn={},yt=ue((t,n)=>{const{value:r,defaultValue:i,onChange:h,size:o,wrapperProps:u,children:s,readOnly:d,...y}=he("CheckboxGroup",Gn,t),[p,I]=Ot({value:r,defaultValue:i,finalValue:[],onChange:h}),m=f=>{const g=typeof f=="string"?f:f.currentTarget.value;!d&&I(p.includes(g)?p.filter(k=>k!==g):[...p,g])};return e.jsx(On,{value:{value:p,onChange:m,size:o},children:e.jsx(Nt.Wrapper,{size:o,ref:n,...u,...y,labelElement:"div",__staticSelector:"CheckboxGroup",children:e.jsx(vn,{role:"group",children:s})})})});yt.classes=Nt.Wrapper.classes;yt.displayName="@mantine/core/CheckboxGroup";var Gt={indicator:"m_5e5256ee",icon:"m_1b1c543a","indicator--outline":"m_76e20374"};const Vn={icon:Mt},Un=Fe((t,{radius:n,color:r,size:i,iconColor:h,variant:o,autoContrast:u})=>{const s=$t({color:r||t.primaryColor,theme:t}),d=s.isThemeColor&&s.shade===void 0?`var(--mantine-color-${s.color}-outline)`:s.color;return{indicator:{"--checkbox-size":mt(i,"checkbox-size"),"--checkbox-radius":n===void 0?void 0:Be(n),"--checkbox-color":o==="outline"?d:Ae(r,t),"--checkbox-icon-color":h?Ae(h,t):ft(u,t)?xt({color:r,theme:t,autoContrast:u}):void 0}}}),jt=ue((t,n)=>{const r=he("CheckboxIndicator",Vn,t),{classNames:i,className:h,style:o,styles:u,unstyled:s,vars:d,icon:y,indeterminate:p,radius:I,color:m,iconColor:f,autoContrast:g,checked:k,mod:j,variant:P,disabled:S,...D}=r,A=$e({name:"CheckboxIndicator",classes:Gt,props:r,className:h,style:o,classNames:i,styles:u,unstyled:s,vars:d,varsResolver:Un,rootSelector:"indicator"}),v=Fn(),O=typeof k=="boolean"||typeof p=="boolean"?k||p:(v==null?void 0:v.checked)||!1;return e.jsx(w,{ref:n,...A("indicator",{variant:P}),variant:P,mod:[{checked:O,disabled:S},j],...D,children:e.jsx(y,{indeterminate:p,...A("icon")})})});jt.displayName="@mantine/core/CheckboxIndicator";jt.classes=Gt;var Vt={root:"m_bf2d988c",inner:"m_26062bec",input:"m_26063560",icon:"m_bf295423","input--outline":"m_215c4542"};const Hn={labelPosition:"right",icon:Mt},Wn=Fe((t,{radius:n,color:r,size:i,iconColor:h,variant:o,autoContrast:u})=>{const s=$t({color:r||t.primaryColor,theme:t}),d=s.isThemeColor&&s.shade===void 0?`var(--mantine-color-${s.color}-outline)`:s.color;return{root:{"--checkbox-size":mt(i,"checkbox-size"),"--checkbox-radius":n===void 0?void 0:Be(n),"--checkbox-color":o==="outline"?d:Ae(r,t),"--checkbox-icon-color":h?Ae(h,t):ft(u,t)?xt({color:r,theme:t,autoContrast:u}):void 0}}}),je=ue((t,n)=>{const r=he("Checkbox",Hn,t),{classNames:i,className:h,style:o,styles:u,unstyled:s,vars:d,color:y,label:p,id:I,size:m,radius:f,wrapperProps:g,checked:k,labelPosition:j,description:P,error:S,disabled:D,variant:A,indeterminate:v,icon:O,rootRef:Y,iconColor:E,onChange:b,autoContrast:z,mod:G,...H}=r,U=Bt(),K=m||(U==null?void 0:U.size),se=$e({name:"Checkbox",props:r,classes:Vt,className:h,style:o,classNames:i,styles:u,unstyled:s,vars:d,varsResolver:Wn}),{styleProps:ie,rest:ce}=bn(H),me=Cn(I),fe=U?{checked:U.value.includes(ce.value),onChange:ee=>{U.onChange(ee),b==null||b(ee)}}:{},ge=a.useRef(null),oe=n||ge;return a.useEffect(()=>{oe&&"current"in oe&&oe.current&&(oe.current.indeterminate=v||!1)},[v,oe]),e.jsx(In,{...se("root"),__staticSelector:"Checkbox",__stylesApiProps:r,id:me,size:K,labelPosition:j,label:p,description:P,error:S,disabled:D,classNames:i,styles:u,unstyled:s,"data-checked":fe.checked||k||void 0,variant:A,ref:Y,mod:G,...ie,...g,children:e.jsxs(w,{...se("inner"),mod:{"data-label-position":j},children:[e.jsx(w,{component:"input",id:me,ref:oe,checked:k,disabled:D,mod:{error:!!S,indeterminate:v},...se("input",{focusable:!0,variant:A}),onChange:b,...ce,...fe,type:"checkbox"}),e.jsx(O,{indeterminate:v,...se("icon")})]})})});je.classes={...Vt,...Sn};je.displayName="@mantine/core/Checkbox";je.Group=yt;je.Indicator=jt;je.Card=pt;const[Jn,Ut]=Mn("Progress.Root component was not found in tree");var Pe={root:"m_db6d6462",section:"m_2242eb65","stripes-animation":"m_81a374bd",label:"m_91e40b74"};const qn={},bt=ue((t,n)=>{const{classNames:r,className:i,style:h,styles:o,vars:u,...s}=he("ProgressLabel",qn,t),d=Ut();return e.jsx(w,{ref:n,...d.getStyles("label",{className:i,style:h,classNames:r,styles:o}),...s})});bt.classes=Pe;bt.displayName="@mantine/core/ProgressLabel";const Qn={},Xn=Fe((t,{size:n,radius:r,transitionDuration:i})=>({root:{"--progress-size":mt(n,"progress-size"),"--progress-radius":r===void 0?void 0:Be(r),"--progress-transition-duration":typeof i=="number"?`${i}ms`:void 0}})),Ve=ue((t,n)=>{const r=he("ProgressRoot",Qn,t),{classNames:i,className:h,style:o,styles:u,unstyled:s,vars:d,autoContrast:y,transitionDuration:p,...I}=r,m=$e({name:"Progress",classes:Pe,props:r,className:h,style:o,classNames:i,styles:u,unstyled:s,vars:d,varsResolver:Xn});return e.jsx(Jn,{value:{getStyles:m,autoContrast:y},children:e.jsx(w,{ref:n,...m("root"),...I})})});Ve.classes=Pe;Ve.displayName="@mantine/core/ProgressRoot";const Kn={withAria:!0},Ue=ue((t,n)=>{const{classNames:r,className:i,style:h,styles:o,vars:u,value:s,withAria:d,color:y,striped:p,animated:I,mod:m,...f}=he("ProgressSection",Kn,t),g=Ut(),k=wn(),j=d?{role:"progressbar","aria-valuemax":100,"aria-valuemin":0,"aria-valuenow":s,"aria-valuetext":`${s}%`}:{};return e.jsx(w,{ref:n,...g.getStyles("section",{className:i,classNames:r,styles:o,style:h}),...f,...j,mod:[{striped:p||I,animated:I},m],__vars:{"--progress-section-width":`${s}%`,"--progress-section-color":Ae(y,k),"--progress-label-color":ft(g.autoContrast,k)?xt({color:y,theme:k,autoContrast:g.autoContrast}):void 0}})});Ue.classes=Pe;Ue.displayName="@mantine/core/ProgressSection";const Zn={},le=ue((t,n)=>{const r=he("Progress",Zn,t),{value:i,classNames:h,styles:o,vars:u,color:s,striped:d,animated:y,"aria-label":p,...I}=r,{resolvedClassNames:m,resolvedStyles:f}=yn({classNames:h,styles:o,props:r});return e.jsx(Ve,{ref:n,classNames:m,styles:f,vars:u,...I,children:e.jsx(Ue,{value:i,color:s,striped:d,animated:y,"aria-label":p})})});le.classes=Pe;le.displayName="@mantine/core/Progress";le.Section=Ue;le.Root=Ve;le.Label=bt;/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Ht=gt("outline","arrow-left","IconArrowLeft",[["path",{d:"M5 12l14 0",key:"svg-0"}],["path",{d:"M5 12l6 6",key:"svg-1"}],["path",{d:"M5 12l6 -6",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Wt=gt("outline","arrow-right","IconArrowRight",[["path",{d:"M5 12l14 0",key:"svg-0"}],["path",{d:"M13 18l6 -6",key:"svg-1"}],["path",{d:"M13 6l6 6",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var es=gt("outline","clock","IconClock",[["path",{d:"M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0",key:"svg-0"}],["path",{d:"M12 7v5l3 3",key:"svg-1"}]]);const Jt=({contents:t,selectedContentIds:n,onSelectionChange:r,loading:i=!1,maxItems:h=50})=>{const{width:o}=nn(),s=(p=>p>=1200?{cols:4,spacing:"md"}:p>=992?{cols:3,spacing:"md"}:p>=768?{cols:3,spacing:"sm"}:p>=576?{cols:2,spacing:"sm"}:{cols:2,spacing:"xs"})(o),d=t.slice(0,h),y=a.useCallback(p=>{const I=n.includes(p);let m;I?m=n.filter(f=>f!==p):m=[...n,p],r(m)},[n,r]);return t.length===0&&!i?e.jsx(ke,{align:"center",justify:"center",mih:"200px",ta:"center",children:e.jsxs("div",{children:[e.jsx(c,{size:"lg",c:"dimmed",mb:"sm",children:"利用可能なコンテンツがありません"}),e.jsx(c,{size:"sm",c:"dimmed",children:"先にコンテンツを追加してください"})]})}):e.jsxs(w,{children:[t.length>h&&e.jsxs(c,{size:"sm",c:"dimmed",mb:"md",ta:"center",children:[t.length,"個中",h,"個のコンテンツを表示中"]}),e.jsx(at,{cols:s.cols,spacing:s.spacing,verticalSpacing:s.spacing,children:d.map(p=>{const I=n.includes(p.id),m=I?n.indexOf(p.id)+1:null;return e.jsxs(w,{pos:"relative",children:[e.jsx(w,{pos:"absolute",top:"8px",right:"8px",style:{zIndex:10,backgroundColor:I?"#4a90e2":"rgba(255, 255, 255, 0.9)",borderRadius:"50%",padding:"4px",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",minWidth:"24px",minHeight:"24px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},onClick:()=>y(p.id),children:I?e.jsx(c,{size:"xs",c:"white",fw:600,children:m}):e.jsx(je,{checked:!1,onChange:()=>y(p.id),size:"sm",color:"blue",style:{pointerEvents:"none"}})}),I&&e.jsx(w,{pos:"absolute",top:"0",left:"0",right:"0",bottom:"0",style:{zIndex:5,backgroundColor:"rgba(74, 144, 226, 0.2)",border:"2px solid #4a90e2",borderRadius:"4px",pointerEvents:"none"}}),e.jsx(w,{style:{cursor:"pointer",transition:"transform 0.2s ease",transform:I?"scale(0.98)":"scale(1)"},onClick:()=>y(p.id),children:e.jsx(sn,{content:p,aspectRatio:16/9})})]},p.id)})}),i&&e.jsx(ke,{align:"center",justify:"center",p:"xl",children:e.jsx(c,{size:"sm",c:"dimmed",children:"読み込み中..."})})]})},qt=({selectedContents:t,onReorder:n,contentDurations:r})=>{const[i,h]=a.useState(null),[o,u]=a.useState(null),s=a.useCallback((f,g)=>{h(g),f.dataTransfer.setData("text/plain",g.toString()),f.dataTransfer.effectAllowed="move"},[]),d=a.useCallback(()=>{h(null),u(null)},[]),y=a.useCallback((f,g)=>{f.preventDefault(),f.dataTransfer.dropEffect="move",u(g)},[]),p=a.useCallback(()=>{u(null)},[]),I=a.useCallback((f,g)=>{f.preventDefault();const k=Number.parseInt(f.dataTransfer.getData("text/plain"),10);if(k===g){h(null),u(null);return}const j=[...t],[P]=j.splice(k,1);j.splice(g,0,P),setTimeout(()=>{h(null),u(null)},50),n(j.map(S=>S.id))},[t,n]),m=f=>{const g=Math.floor(f/60),k=f%60;return`${g}:${k.toString().padStart(2,"0")}`};return t.length===0?e.jsx(Z,{p:"md",withBorder:!0,mih:"120px",children:e.jsx(c,{size:"sm",c:"dimmed",ta:"center",children:"コンテンツを選択すると、ここに順序付きで表示されます"})}):e.jsxs(Z,{p:"md",withBorder:!0,children:[e.jsxs($,{justify:"space-between",mb:"sm",children:[e.jsxs(c,{size:"sm",fw:500,children:["選択済み (",t.length,"件)"]}),e.jsx(c,{size:"xs",c:"dimmed",children:"ドラッグして順序を変更"})]}),e.jsx(ne,{gap:"xs",children:e.jsx(It,{children:t.map((f,g)=>{const k=i===g,j=o===g;return e.jsxs("div",{children:[e.jsx(It,{children:j&&i!==g&&i!==null&&e.jsx(St.div,{initial:{opacity:0,height:0,scaleY:0},animate:{opacity:1,height:4,scaleY:1},exit:{opacity:0,height:0,scaleY:0},transition:{duration:.2,ease:"easeInOut"},style:{backgroundColor:"#4a90e2",borderRadius:"2px",margin:"4px 0",transformOrigin:"center"}},`indicator-${f.id}-${g}`)}),e.jsx(St.div,{layout:!0,layoutId:`content-${f.id}`,initial:{opacity:0,y:20},animate:{opacity:1,y:0,scale:k?1.02:1},exit:{opacity:0,y:-20},transition:{layout:{duration:.3,ease:"easeInOut"},opacity:{duration:.2},scale:{duration:.2,ease:"easeOut"}},whileDrag:{scale:1.05,rotate:2,zIndex:100,boxShadow:"0 10px 30px rgba(0, 0, 0, 0.2)"},dragConstraints:{left:0,right:0},dragElastic:.1,children:e.jsx(Z,{p:"xs",withBorder:!0,draggable:!0,style:{cursor:k?"grabbing":"grab",opacity:k?.9:1,backgroundColor:j&&i!==g?"blue.0":void 0,borderColor:j&&i!==g?"blue.4":void 0},onDragStart:P=>s(P,g),onDragEnd:d,onDragOver:P=>y(P,g),onDragLeave:p,onDrop:P=>I(P,g),children:e.jsxs($,{gap:"sm",wrap:"nowrap",children:[e.jsx(ke,{miw:"24px",h:"24px",bg:"#4a90e2",style:{borderRadius:"50%"},align:"center",justify:"center",children:e.jsx(c,{size:"xs",c:"white",fw:600,children:g+1})}),e.jsx(w,{c:"gray.5",children:e.jsx(zn,{size:16})}),e.jsx(ke,{w:"40px",h:"30px",bg:"gray.1",c:"gray.6",style:{borderRadius:"4px",flexShrink:0,fontSize:"10px"},align:"center",justify:"center",children:f.type==="image"?"📷":f.type==="video"?"🎬":"📄"}),e.jsxs(w,{flex:1,style:{overflow:"hidden"},children:[e.jsx(c,{size:"sm",fw:500,lineClamp:1,children:f.name}),e.jsxs(c,{size:"xs",c:"dimmed",children:[f.type==="image"?"画像":f.type==="video"?"動画":"その他",f.size&&` • ${(f.size/1024/1024).toFixed(1)}MB`,(r==null?void 0:r[f.id])&&` • ${m(r[f.id])}`]})]})]})})},f.id)]},`wrapper-${f.id}`)})})})]})},zt=1920,kt=1080,ts=t=>t==="portrait-right"||t==="portrait-left"?{width:kt,height:zt}:{width:zt,height:kt},At=[{bg:"rgba(74, 144, 226, 0.2)",border:"#4a90e2",bgSelected:"rgba(74, 144, 226, 0.4)"},{bg:"rgba(82, 196, 26, 0.2)",border:"#52c41a",bgSelected:"rgba(82, 196, 26, 0.4)"},{bg:"rgba(250, 173, 20, 0.2)",border:"#faad14",bgSelected:"rgba(250, 173, 20, 0.4)"},{bg:"rgba(245, 34, 45, 0.2)",border:"#f5222d",bgSelected:"rgba(245, 34, 45, 0.4)"}],ns=(t,n=!1)=>{const r=At[t%At.length];return{backgroundColor:n?r.bgSelected:r.bg,borderColor:r.border}},Qt=({layout:t,selectedRegionId:n,onRegionClick:r,assignedContentCounts:i={},canvasWidth:h=600,canvasHeight:o=338})=>{const{colorScheme:u}=An(),s=ts(t.orientation),d=Math.min(h/s.width,o/s.height),y=s.width*d,p=s.height*d,I=a.useCallback(m=>{r&&r(m)},[r]);return e.jsxs(w,{children:[e.jsxs(c,{size:"sm",mb:"xs",ta:"center",c:"dimmed",children:[t.name," (",t.orientation==="landscape"?"横向き":t.orientation==="portrait-right"?"縦向き(右)":"縦向き(左)"," ","- ",t.regions.length,"リージョン)"]}),e.jsxs(Z,{withBorder:!0,p:"md",pos:"relative",w:y,h:p,mx:"auto",bg:"gray.0",style:{overflow:"hidden"},children:[e.jsx(w,{pos:"absolute",top:0,left:0,w:y,h:p,bg:u==="dark"?"dark.6":"gray.1",style:{borderRadius:"4px"}}),t.regions.map((m,f)=>{const g=n===m.id,k=i[m.id]||0,j=ns(f,g);return e.jsxs(ke,{direction:"column",align:"center",justify:"center",style:{position:"absolute",left:m.x*d,top:m.y*d,width:m.width*d,height:m.height*d,backgroundColor:j.backgroundColor,border:`2px solid ${j.borderColor}`,borderRadius:"4px",cursor:r?"pointer":"default",transition:"all 0.2s ease",zIndex:g?10:5,boxShadow:g?`0 0 0 2px ${j.borderColor}`:"none"},onClick:()=>I(m.id),children:[e.jsxs(c,{size:"xs",fw:600,c:g?"dark":"dimmed",ta:"center",style:{pointerEvents:"none"},children:["リージョン ",f+1]}),e.jsxs(c,{size:"xs",c:g?"dark":"dimmed",ta:"center",style:{pointerEvents:"none"},children:[m.width," × ",m.height]}),k>0&&e.jsxs(c,{size:"xs",fw:600,c:"blue",ta:"center",style:{pointerEvents:"none"},children:[k,"個のコンテンツ"]})]},m.id)}),!n&&r&&t.regions.length>0&&e.jsx(w,{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",textAlign:"center",pointerEvents:"none",zIndex:1},children:e.jsx(c,{size:"sm",c:"dimmed",fw:500,children:"リージョンをクリックして選択"})})]})]})},Dt=[{bg:"rgba(74, 144, 226, 0.2)",border:"#4a90e2"},{bg:"rgba(82, 196, 26, 0.2)",border:"#52c41a"},{bg:"rgba(250, 173, 20, 0.2)",border:"#faad14"},{bg:"rgba(245, 34, 45, 0.2)",border:"#f5222d"}],Pt=1920,Et=1080,ss=t=>t==="portrait-right"||t==="portrait-left"?{width:Et,height:Pt}:{width:Pt,height:Et},rs=({layout:t,isSelected:n,onClick:r})=>{const[i,h]=a.useState(null),[o,u]=a.useState(!0),[s,d]=a.useState(200),y=a.useRef(null),{getLayoutById:p}=Ge();a.useEffect(()=>{const S=()=>{if(y.current){const A=y.current.getBoundingClientRect();d(A.width)}};S(),window.addEventListener("resize",S);const D=new ResizeObserver(S);return y.current&&D.observe(y.current),()=>{window.removeEventListener("resize",S),D.disconnect()}},[]),a.useEffect(()=>{(async()=>{try{u(!0);const D=await p(t.id);h(D)}catch(D){console.error("Failed to load layout details:",D)}finally{u(!1)}})()},[t.id,p]);const I=ss(t.orientation),m=s,f=m/I.width,g=I.height*f,k=Math.round(g)+80,j=()=>!i||o?e.jsx(w,{w:"100%",h:"100%",style:{display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f8f9fa",color:"#868e96",fontSize:"11px"},children:o?"読み込み中...":"プレビュー未対応"}):e.jsx(w,{w:"100%",h:"100%",pos:"relative",bg:"#f8f9fa",children:i.regions.map((S,D)=>{const A=Dt[D%Dt.length];return e.jsxs(w,{pos:"absolute",style:{left:`${S.x*f}px`,top:`${S.y*f}px`,width:`${S.width*f}px`,height:`${S.height*f}px`,backgroundColor:A.bg,border:`1px solid ${A.border}`,borderRadius:"2px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"8px",color:"white",fontWeight:700,textShadow:"1px 1px 2px rgba(0,0,0,0.6)"},children:["リージョン ",D+1]},S.id)})}),P=()=>{switch(t.orientation){case"landscape":return"#228be6";case"portrait-right":return"#fa8c16";case"portrait-left":return"#722ed1";default:return"#40c057"}};return e.jsxs(Z,{ref:y,withBorder:!0,p:0,w:"100%",h:k,style:{cursor:"pointer",borderColor:n?"#228be6":void 0,borderWidth:n?"2px":"1px",backgroundColor:n?"#f0f8ff":void 0,transition:"all 0.2s ease"},onClick:r,children:[e.jsxs(w,{pos:"relative",children:[n&&e.jsx(w,{pos:"absolute",top:4,right:4,style:{zIndex:10,width:"20px",height:"20px",backgroundColor:"#228be6",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:"10px",fontWeight:"bold"},children:"✓"}),e.jsx(w,{style:{height:`${g}px`,width:`${m}px`,overflow:"hidden",position:"relative"},children:j()})]}),e.jsxs(w,{p:"xs",h:"80px",style:{overflow:"hidden"},children:[e.jsx(c,{size:"sm",fw:500,lineClamp:1,mb:"xs",children:t.name}),e.jsxs(w,{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx(c,{size:"xs",c:"dimmed",children:new Date(t.createdAt).toLocaleDateString("ja-JP")}),e.jsxs(c,{size:"xs",style:{color:P(),fontWeight:500},children:[t.orientation==="landscape"?"横向き":t.orientation==="portrait-right"?"縦向き(右)":"縦向き(左)"," ","- ",t.regionCount,"リージョン"]})]})]})]})},os=({layouts:t,selectedLayoutId:n,loading:r,onLayoutSelect:i})=>r?e.jsx(at,{cols:{base:1,sm:2,md:3},spacing:"md",children:Array.from({length:6},()=>crypto.randomUUID()).map(h=>e.jsx(w,{h:"180px",bg:"#f8f9fa",style:{borderRadius:"8px"}},h))}):t.length===0?e.jsxs(Z,{p:"xl",withBorder:!0,style:{textAlign:"center"},children:[e.jsx(c,{c:"dimmed",mb:"sm",children:"利用可能なレイアウトがありません"}),e.jsx(c,{size:"sm",c:"dimmed",children:"新しいレイアウトを作成してください"})]}):e.jsxs(e.Fragment,{children:[e.jsx(at,{cols:{base:1,sm:2,md:3},spacing:"md",children:t.map(h=>e.jsx(rs,{layout:h,isSelected:n===h.id,onClick:()=>i(h)},h.id))}),e.jsxs(c,{ta:"center",c:"dimmed",mt:"md",size:"sm",children:["レイアウトを選択してください (",t.length," 件)"]})]});let _e=null;const is=()=>_e||(_e=new Promise(t=>{if(window.YT){t();return}window.onYouTubeIframeAPIReady=()=>{t()};const n=document.createElement("script");n.src="https://www.youtube.com/iframe_api",n.async=!0,document.head.appendChild(n)}),_e),as=async t=>{try{return await is(),new Promise(n=>{const r=document.createElement("div");r.style.position="fixed",r.style.left="-9999px",r.style.width="1px",r.style.height="1px",r.id=`yt-player-${t}`,document.body.appendChild(r);const i=setTimeout(()=>{r.remove(),J.warn("YouTube",`Timeout getting duration for video ${t}`),n(null)},1e4),h=new window.YT.Player(r.id,{videoId:t,events:{onReady:o=>{clearTimeout(i);const u=o.target.getDuration();o.target.destroy(),r.remove(),u>0?(J.info("YouTube",`Video ${t} duration: ${u} seconds`),n(Math.ceil(u))):(J.warn("YouTube",`Invalid duration for video ${t}`),n(null))},onError:o=>{clearTimeout(i),r.remove(),J.error("YouTube",`Error loading video ${t}: ${o.data}`),n(null)}}})})}catch(n){return J.error("YouTube","Failed to get video duration",n),null}},Tt=new Map,Xt=async t=>{const n=Tt.get(t);if(n!==void 0)return n;const r=await as(t);return r!==null&&Tt.set(t,r),r},Kt=({opened:t,onClose:n,contentName:r,contentType:i,currentDuration:h,onSubmit:o,onCancel:u})=>{const[s,d]=a.useState(h||30),[y,p]=a.useState(""),I=()=>{if(s<1){p("再生時間は1秒以上である必要があります");return}if(s>3600){p("再生時間は1時間（3600秒）以内にしてください");return}o(s),n()},m=()=>{u&&u(),n()},f=g=>{const k=Math.floor(g/60),j=g%60;return`${k}分${j}秒`};return e.jsx(Oe,{opened:t,onClose:m,title:"再生時間の設定",centered:!0,size:"sm",children:e.jsxs(ne,{gap:"md",children:[e.jsxs(c,{size:"sm",c:"dimmed",children:[e.jsx(c,{span:!0,fw:500,children:r})," ","の再生時間を設定してください。"]}),(i==="image"||i==="text"||i==="rich-text"||i==="url")&&e.jsx(c,{size:"xs",c:"dimmed",children:"このコンテンツタイプは自動的に再生時間を決定できないため、手動で設定する必要があります。"}),i==="youtube"&&e.jsx(c,{size:"xs",c:"dimmed",children:"YouTube動画の再生時間を自動取得できませんでした。動画プレーヤーで確認した正確な時間を手動で入力してください。"}),e.jsx(mn,{label:"再生時間（秒）",placeholder:"30",value:s,onChange:g=>{d(Number(g)||30),p("")},min:1,max:3600,step:1,leftSection:e.jsx(es,{size:16}),error:y,description:`現在の設定: ${f(s)}`}),e.jsxs($,{justify:"flex-end",children:[e.jsx(X,{variant:"subtle",onClick:m,children:"キャンセル"}),e.jsx(X,{leftSection:e.jsx(ht,{size:16}),onClick:I,children:"設定"})]})]})})},ls=({opened:t,onClose:n,onSubmit:r})=>{const[i,h]=a.useState(!1),[o,u]=a.useState("basic"),[s,d]=a.useState({name:`プレイリスト ${new Date().toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}`,device:"",layoutId:"",contentAssignments:[]}),[y,p]=a.useState({name:"",device:"",layoutId:"",contentAssignments:[]}),[I,m]=a.useState({}),[f,g]=a.useState([]),[k,j]=a.useState(null),[P,S]=a.useState([]),[D,A]=a.useState(!1),[v,O]=a.useState(null),[Y,E]=a.useState(null),[b,z]=a.useState(!1),[G,H]=a.useState(!1),[U,K]=a.useState(null),[se,ie]=a.useState(null),{getLayoutsIndex:ce,getLayoutById:me,createLayout:fe}=Ge(),{getContentsIndex:ge,getContentById:oe,createFileOrTextContent:ee,createUrlContent:ae,createRichTextContent:He}=dt(),re=[{key:"basic",title:"基本情報",description:"プレイリスト名とデバイスを設定"},{key:"layout",title:"レイアウト選択",description:"既存レイアウトを選択または新規作成"},{key:"content",title:"コンテンツ割り当て",description:"各リージョンにコンテンツを割り当て"}],te=()=>re.findIndex(l=>l.key===o),We=()=>(te()+1)/re.length*100,be=a.useCallback(async()=>{try{const l=await ce();g(l)}catch(l){J.error("PlaylistCreateModal","Failed to load layouts",l)}},[ce]),xe=a.useCallback(async()=>{try{const l=await ge();S(l)}catch(l){J.error("PlaylistCreateModal","Failed to load contents",l)}},[ge]);a.useEffect(()=>{t&&(async()=>{await be(),await xe();const C={name:`プレイリスト ${new Date().toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}`,device:"",layoutId:"",contentAssignments:[]};d(C),p(C)})()},[t,be,xe]);const Je=a.useMemo(()=>s.name.trim()!==y.name.trim()||s.device.trim()!==y.device.trim()||s.layoutId!==y.layoutId||JSON.stringify(s.contentAssignments)!==JSON.stringify(y.contentAssignments)||v!==null,[s,y,v]),Ee=()=>{const l={};return o==="basic"?(s.name.trim().length===0&&(l.name="プレイリスト名は必須です"),s.device.trim().length===0&&(l.device="デバイス名は必須です")):o==="layout"&&s.layoutId.trim().length===0&&!v&&(l.layoutId="レイアウトを選択するか、新しいレイアウトを作成してください"),m(l),Object.keys(l).length===0},Te=async()=>{if(!Ee())return;const l=te();if(l<re.length-1){const C=re[l+1].key;if(o==="layout"&&C==="content"){if(v){const L={id:"temp-layout",name:v.name,orientation:v.orientation,regions:v.regions,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};j(L);const B=v.regions.map(M=>({regionId:M.id,contentIds:[],contentDurations:[]}));d(M=>({...M,contentAssignments:B}))}else if(s.layoutId)try{const L=await me(s.layoutId);if(j(L),L){const B=L.regions.map(M=>({regionId:M.id,contentIds:[],contentDurations:[]}));d(M=>({...M,contentAssignments:B}))}}catch(L){J.error("PlaylistCreateModal","Failed to load layout",L);return}}u(C)}},Ce=()=>{const l=te();l>0&&u(re[l-1].key)},Le=async()=>{if(Ee()){h(!0);try{let l=s.layoutId;v&&(l=(await fe({name:v.name,orientation:v.orientation,regions:v.regions})).id),await r({name:s.name.trim(),device:s.device.trim(),layoutId:l,contentAssignments:s.contentAssignments}),we(),n()}catch(l){J.error("PlaylistCreateModal","プレイリスト作成エラー",l)}finally{h(!1)}}},Re=()=>{Je?Ne.openConfirmModal({title:"変更を破棄しますか？",children:e.jsx(c,{size:"sm",children:"保存されていない変更があります。本当に閉じてもよろしいですか？"}),labels:{confirm:"破棄して閉じる",cancel:"キャンセル"},confirmProps:{color:"red"},onConfirm:()=>{we(),n()}}):(we(),n())},we=()=>{u("basic");const l={name:`プレイリスト ${new Date().toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}`,device:"",layoutId:"",contentAssignments:[]};d(l),p(l),m({}),j(null),A(!1),O(null),E(null)},pe=async(l,C)=>{var W,ve,Ie;const L=s.contentAssignments.find(V=>V.regionId===l),B=(L==null?void 0:L.contentIds)||[],M=C.filter(V=>!B.includes(V));let N=(L==null?void 0:L.contentDurations)||[];if(M.length>0){const V=P.find(q=>q.id===M[0]);if(V)if(V.type==="video")try{const q=await oe(V.id);(ve=(W=q==null?void 0:q.fileInfo)==null?void 0:W.metadata)!=null&&ve.duration&&(N=[...N,{contentId:V.id,duration:Math.ceil(q.fileInfo.metadata.duration)}])}catch(q){J.error("PlaylistCreateModal","Failed to get video duration",q)}else if(V.type==="youtube")try{const q=await oe(V.id);if((Ie=q==null?void 0:q.urlInfo)!=null&&Ie.url){const Ct=ut(q.urlInfo.url);if(Ct){const wt=await Xt(Ct);if(wt!==null)N=[...N,{contentId:V.id,duration:wt}];else{ie({regionId:l,contentIds:C}),K({contentId:V.id,contentName:V.name,contentType:V.type}),H(!0);return}}}}catch(q){J.error("PlaylistCreateModal","Failed to get YouTube video info",q),ie({regionId:l,contentIds:C}),K({contentId:V.id,contentName:V.name,contentType:V.type}),H(!0);return}else{ie({regionId:l,contentIds:C}),K({contentId:V.id,contentName:V.name,contentType:V.type}),H(!0);return}}const _=B.filter(V=>!C.includes(V));_.length>0&&(N=N.filter(V=>!_.includes(V.contentId))),d(V=>({...V,contentAssignments:V.contentAssignments.map(q=>q.regionId===l?{...q,contentIds:C,contentDurations:N}:q)}))},qe=(l,C)=>{pe(l,C)},Qe=l=>{E(l)},ye=()=>Y?s.contentAssignments.find(l=>l.regionId===Y):null,Xe=()=>{const l={};return s.contentAssignments.forEach(C=>{l[C.regionId]=C.contentIds.length}),l},Ke=()=>te()<re.length-1,Ze=()=>te()>0,et=async l=>{O(l),A(!1),d(B=>({...B,layoutId:""}));const C={id:"temp-layout",name:l.name,orientation:l.orientation,regions:l.regions,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};j(C);const L=l.regions.map(B=>({regionId:B.id,contentIds:[],contentDurations:[]}));d(B=>({...B,contentAssignments:L})),E(null),u("content")},tt=()=>{A(!1)},nt=async(l,C)=>{for(let L=0;L<l.length;L++)await ee(l[L],C==null?void 0:C[L]);await xe()},st=async l=>{await ae(l.url,l.name,l.title,l.description),await xe()},rt=async l=>{await He(l.name,l.richTextInfo),await xe()},ot=l=>{if(U){if(se){const{regionId:C,contentIds:L}=se,B=s.contentAssignments.find(N=>N.regionId===C),M=[...(B==null?void 0:B.contentDurations)||[],{contentId:U.contentId,duration:l}];d(N=>({...N,contentAssignments:N.contentAssignments.map(_=>_.regionId===C?{..._,contentIds:L,contentDurations:M}:_)})),ie(null)}else Y&&d(C=>{const L=C.contentAssignments.map(B=>{if(B.regionId===Y){const N=(B.contentDurations||[]).filter(_=>_.contentId!==U.contentId);return N.push({contentId:U.contentId,duration:l}),{...B,contentDurations:N}}return B});return{...C,contentAssignments:L}});H(!1),K(null)}},Me=()=>{se&&ie(null),H(!1),K(null)},x=(l,C)=>{var M;const L=s.contentAssignments.find(N=>N.regionId===l),B=(M=L==null?void 0:L.contentDurations)==null?void 0:M.find(N=>N.contentId===C);return B==null?void 0:B.duration},R=()=>{var l,C,L,B;switch(o){case"basic":return e.jsxs(ne,{gap:"md",children:[e.jsx(ze,{label:"プレイリスト名",placeholder:"プレイリスト名を入力してください",required:!0,value:s.name,onChange:M=>d(N=>({...N,name:M.target.value})),error:I.name}),e.jsx(ze,{label:"デバイス名",placeholder:"対象デバイス名を入力してください",required:!0,value:s.device,onChange:M=>d(N=>({...N,device:M.target.value})),error:I.device})]});case"layout":return e.jsxs(ne,{gap:"md",children:[f.length>0&&e.jsxs(w,{children:[e.jsx(c,{size:"sm",fw:500,mb:"sm",children:"既存のレイアウトから選択"}),e.jsx(os,{layouts:f,selectedLayoutId:s.layoutId,onLayoutSelect:M=>{d(N=>({...N,layoutId:M.id})),O(null)}}),I.layoutId&&!v&&e.jsx(c,{size:"sm",c:"red",mt:"xs",children:I.layoutId})]}),f.length>0&&e.jsx(ct,{label:"または",labelPosition:"center"}),e.jsxs(w,{children:[e.jsx(c,{size:"sm",fw:500,mb:"sm",children:"新しいレイアウトを作成"}),v?e.jsx(Z,{p:"md",withBorder:!0,children:e.jsxs($,{justify:"space-between",align:"flex-start",children:[e.jsxs(w,{children:[e.jsxs(c,{size:"sm",fw:500,children:["作成済みレイアウト: ",v.name]}),e.jsxs(c,{size:"xs",c:"dimmed",children:[v.orientation==="landscape"?"横向き":v.orientation==="portrait-right"?"縦向き(右)":"縦向き(左)"," ","- ",v.regions.length,"リージョン"]})]}),e.jsx(X,{variant:"subtle",size:"xs",onClick:()=>{O(null)},children:"削除"})]})}):e.jsx(X,{variant:"light",onClick:()=>A(!0),leftSection:e.jsx(Dn,{size:16}),size:"lg",fullWidth:!0,children:"新しいレイアウトを作成"})]})]});case"content":return e.jsx(ne,{gap:"md",children:k?k.regions.length===0?e.jsx(Z,{p:"md",withBorder:!0,children:e.jsx(c,{c:"dimmed",ta:"center",children:"このレイアウトにはリージョンがありません"})}):e.jsxs($,{align:"flex-start",gap:"md",mih:"600px",wrap:"nowrap",children:[e.jsxs(ne,{children:[e.jsx(w,{children:e.jsx(Qt,{layout:k,selectedRegionId:Y,onRegionClick:Qe,assignedContentCounts:Xe(),canvasWidth:350,canvasHeight:197})}),e.jsx(w,{children:Y?e.jsx(qt,{selectedContents:((l=ye())==null?void 0:l.contentIds.map(M=>P.find(N=>N.id===M)).filter(Boolean))||[],onReorder:M=>{Y&&qe(Y,M)},contentDurations:(L=(C=ye())==null?void 0:C.contentDurations)==null?void 0:L.reduce((M,N)=>(M[N.contentId]=N.duration,M),{})}):e.jsx(Z,{p:"md",withBorder:!0,style:{minHeight:"120px"},children:e.jsx(c,{size:"sm",c:"dimmed",ta:"center",children:"リージョンを選択すると、選択済みコンテンツが表示されます"})})})]}),e.jsx(w,{style:{flex:"1 1 auto"},children:Y?e.jsxs(e.Fragment,{children:[e.jsxs($,{justify:"space-between",mb:"sm",children:[e.jsxs(c,{fw:600,children:["リージョン ",k.regions.findIndex(M=>M.id===Y)+1," ","のコンテンツを選択"]}),e.jsx(X,{variant:"light",size:"xs",leftSection:e.jsx(De,{size:14}),onClick:()=>z(!0),children:"コンテンツを追加"})]}),P.length===0?e.jsxs(Z,{p:"xl",withBorder:!0,style:{textAlign:"center"},children:[e.jsx(c,{c:"dimmed",mb:"sm",children:"利用可能なコンテンツがありません"}),e.jsx(c,{size:"sm",c:"dimmed",mb:"md",children:"先にコンテンツを追加してください"}),e.jsx(X,{variant:"filled",leftSection:e.jsx(De,{size:16}),onClick:()=>z(!0),children:"コンテンツを追加"})]}):e.jsx(Jt,{contents:P,selectedContentIds:((B=ye())==null?void 0:B.contentIds)||[],onSelectionChange:M=>{Y&&pe(Y,M)},loading:!1,maxItems:20})]}):e.jsxs(Z,{p:"xl",withBorder:!0,style:{textAlign:"center"},children:[e.jsx(c,{c:"dimmed",mb:"sm",children:"左のレイアウトプレビューからリージョンを選択してください"}),e.jsx(c,{size:"sm",c:"dimmed",children:"選択したリージョンにコンテンツを割り当てることができます"})]})})]}):e.jsx(c,{c:"dimmed",children:"レイアウト情報を読み込み中..."})});default:return null}},F=()=>o==="content"?"95%":o==="layout"?"xl":"lg",T=()=>{if(o==="content")return{content:{maxWidth:"1400px"}};if(o==="layout")return{content:{maxWidth:"1000px"}}};return e.jsxs(e.Fragment,{children:[e.jsx(Oe,{opened:t,onClose:Re,title:"新しいプレイリストを作成",centered:!0,size:F(),styles:T(),children:e.jsxs(ne,{gap:"lg",children:[e.jsxs(w,{children:[e.jsxs($,{justify:"space-between",mb:"xs",children:[e.jsx(c,{size:"sm",fw:500,children:re[te()].title}),e.jsxs(c,{size:"xs",c:"dimmed",children:[te()+1," / ",re.length]})]}),e.jsx(le,{value:We(),size:"sm"}),e.jsx(c,{size:"xs",c:"dimmed",mt:"xs",children:re[te()].description})]}),e.jsx(ct,{}),R(),e.jsxs($,{justify:"space-between",mt:"lg",children:[e.jsxs($,{children:[e.jsx(X,{variant:"subtle",leftSection:e.jsx(lt,{size:16}),onClick:Re,disabled:i,children:"キャンセル"}),Ze()&&e.jsx(X,{variant:"light",leftSection:e.jsx(Ht,{size:16}),onClick:Ce,disabled:i,children:"戻る"})]}),e.jsx($,{children:Ke()?e.jsx(X,{rightSection:e.jsx(Wt,{size:16}),onClick:Te,disabled:i,children:"次へ"}):e.jsx(X,{leftSection:e.jsx(ht,{size:16}),onClick:Le,loading:i,children:"作成"})})]})]})}),e.jsx(kn,{opened:D,onClose:tt,onSubmit:et,title:"新しいレイアウトを作成",submitButtonText:"作成"}),e.jsx(Lt,{opened:b,onClose:()=>z(!1),onFileSubmit:nt,onUrlSubmit:st,onRichTextSubmit:rt}),U&&e.jsx(Kt,{opened:G,onClose:Me,contentName:U.contentName,contentType:U.contentType,currentDuration:Y?x(Y,U.contentId):void 0,onSubmit:ot,onCancel:Me})]})},cs=({opened:t,onClose:n,onSubmit:r,playlist:i})=>{const[h,o]=a.useState(!1),[u,s]=a.useState("basic"),[d,y]=a.useState({name:"",device:"",contentAssignments:[]}),[p,I]=a.useState({}),[m,f]=a.useState(null),[g,k]=a.useState([]),[j,P]=a.useState(null),[S,D]=a.useState(null),[A,v]=a.useState(!1),[O,Y]=a.useState(!1),[E,b]=a.useState(null),[z,G]=a.useState(null),[H,U]=a.useState("all"),[K,se]=a.useState(""),{getLayoutById:ie}=Ge(),{getContentsIndex:ce,getContentById:me,createFileOrTextContent:fe,createUrlContent:ge,createRichTextContent:oe}=dt(),ee=[{key:"basic",title:"基本情報",description:"プレイリスト名とデバイスを編集"},{key:"content",title:"コンテンツ編集",description:"各リージョンのコンテンツを編集"}],ae=()=>ee.findIndex(x=>x.key===u),He=()=>(ae()+1)/ee.length*100,re=a.useCallback(async()=>{if(i!=null&&i.layoutId)try{const x=await ie(i.layoutId);f(x)}catch(x){J.error("PlaylistEditModal","Failed to load layout",x)}},[i==null?void 0:i.layoutId,ie]),te=a.useCallback(async()=>{try{const x=await ce();k(x)}catch(x){J.error("PlaylistEditModal","Failed to load contents",x)}},[ce]);a.useEffect(()=>{i&&t&&(s("basic"),P(null),re(),te())},[i,t,re,te]),a.useEffect(()=>{if(i&&m&&t){const x=m.regions.map(F=>{var l;return((l=i.contentAssignments)==null?void 0:l.find(C=>C.regionId===F.id))||{regionId:F.id,contentIds:[],contentDurations:[]}}),R={name:i.name,device:i.device,contentAssignments:x};y(R),D(R)}},[i,m,t]);const We=a.useCallback(()=>{if(!S)return!1;if(d.name!==S.name||d.device!==S.device)return!0;const x=JSON.stringify(d.contentAssignments),R=JSON.stringify(S.contentAssignments);return x!==R},[d,S]),be=()=>{const x={};return u==="basic"&&(d.name.trim().length===0&&(x.name="プレイリスト名は必須です"),d.device.trim().length===0&&(x.device="デバイス名は必須です")),u==="content"&&(d.name.trim().length===0&&(x.name="プレイリスト名は必須です"),d.device.trim().length===0&&(x.device="デバイス名は必須です")),I(x),Object.keys(x).length===0},xe=()=>{if(!be())return;const x=ae();x<ee.length-1&&s(ee[x+1].key)},Je=()=>{const x=ae();x>0&&s(ee[x-1].key)},Ee=async()=>{if(be()){o(!0);try{await r({name:d.name.trim(),device:d.device.trim(),contentAssignments:d.contentAssignments}),Ce(),n()}catch(x){J.error("PlaylistEditModal","プレイリスト更新エラー",x),Ne.openConfirmModal({title:"更新エラー",children:e.jsx(c,{size:"sm",children:"プレイリストの更新中にエラーが発生しました。もう一度お試しください。"}),labels:{confirm:"OK",cancel:""},cancelProps:{display:"none"}})}finally{o(!1)}}},Te=()=>{We()?Ne.openConfirmModal({title:"変更を破棄しますか？",children:e.jsx(c,{size:"sm",children:"保存されていない変更があります。本当に閉じてもよろしいですか？"}),labels:{confirm:"破棄して閉じる",cancel:"キャンセル"},confirmProps:{color:"red"},onConfirm:()=>{Ce(),n()}}):(Ce(),n())},Ce=()=>{s("basic"),y({name:"",device:"",contentAssignments:[]}),D(null),I({}),f(null),P(null),U("all"),se("")},Le=async(x,R)=>{var B,M,N;const F=d.contentAssignments.find(_=>_.regionId===x),T=(F==null?void 0:F.contentIds)||[],l=R.filter(_=>!T.includes(_));let C=(F==null?void 0:F.contentDurations)||[];if(l.length>0){const _=g.find(W=>W.id===l[0]);if(_)if(_.type==="video")try{const W=await me(_.id);(M=(B=W==null?void 0:W.fileInfo)==null?void 0:B.metadata)!=null&&M.duration&&(C=[...C,{contentId:_.id,duration:Math.ceil(W.fileInfo.metadata.duration)}])}catch(W){J.error("PlaylistEditModal","Failed to get video duration",W)}else if(_.type==="youtube")try{const W=await me(_.id);if((N=W==null?void 0:W.urlInfo)!=null&&N.url){const ve=ut(W.urlInfo.url);if(ve){const Ie=await Xt(ve);if(Ie!==null)C=[...C,{contentId:_.id,duration:Ie}];else{G({regionId:x,contentIds:R}),b({contentId:_.id,contentName:_.name,contentType:_.type}),Y(!0);return}}}}catch(W){J.error("PlaylistEditModal","Failed to get YouTube video info",W),G({regionId:x,contentIds:R}),b({contentId:_.id,contentName:_.name,contentType:_.type}),Y(!0);return}else{G({regionId:x,contentIds:R}),b({contentId:_.id,contentName:_.name,contentType:_.type}),Y(!0);return}}const L=T.filter(_=>!R.includes(_));L.length>0&&(C=C.filter(_=>!L.includes(_.contentId))),y(_=>({..._,contentAssignments:_.contentAssignments.map(W=>W.regionId===x?{...W,contentIds:R,contentDurations:C}:W)}))},Re=async(x,R)=>{await Le(x,R)},we=x=>{P(x)},pe=()=>j?d.contentAssignments.find(x=>x.regionId===j):null,qe=()=>{const x={};return d.contentAssignments.forEach(R=>{x[R.regionId]=R.contentIds.length}),x},Qe=x=>{if(E){if(z){const{regionId:R,contentIds:F}=z,T=d.contentAssignments.find(C=>C.regionId===R),l=[...(T==null?void 0:T.contentDurations)||[],{contentId:E.contentId,duration:x}];y(C=>({...C,contentAssignments:C.contentAssignments.map(L=>L.regionId===R?{...L,contentIds:F,contentDurations:l}:L)})),G(null)}else j&&y(R=>{const F=R.contentAssignments.map(T=>{if(T.regionId===j){const C=(T.contentDurations||[]).filter(L=>L.contentId!==E.contentId);return C.push({contentId:E.contentId,duration:x}),{...T,contentDurations:C}}return T});return{...R,contentAssignments:F}});Y(!1),b(null)}},ye=()=>{z&&G(null),Y(!1),b(null)},Xe=(x,R)=>{var l;const F=d.contentAssignments.find(C=>C.regionId===x),T=(l=F==null?void 0:F.contentDurations)==null?void 0:l.find(C=>C.contentId===R);return T==null?void 0:T.duration},Ke=a.useCallback(()=>{let x=g;if(H!=="all"&&(x=x.filter(R=>R.type===H)),K.trim()){const R=K.toLowerCase();x=x.filter(F=>{var T;return F.name.toLowerCase().includes(R)||F.tags.some(l=>l.toLowerCase().includes(R))||((T=F.url)==null?void 0:T.toLowerCase().includes(R))})}return x},[g,H,K]),Ze=()=>ae()<ee.length-1,et=()=>ae()>0,tt=async(x,R)=>{for(let F=0;F<x.length;F++)await fe(x[F],R==null?void 0:R[F]);await te()},nt=async x=>{await ge(x.url,x.name,x.title,x.description),await te()},st=async x=>{await oe(x.name,x.richTextInfo),await te()},rt=()=>{var x,R,F;switch(u){case"basic":return e.jsxs(ne,{gap:"md",children:[e.jsx(ze,{label:"プレイリスト名",placeholder:"プレイリスト名を入力してください",required:!0,value:d.name,onChange:T=>y(l=>({...l,name:T.target.value})),error:p.name}),e.jsx(ze,{label:"デバイス名",placeholder:"対象デバイス名を入力してください",required:!0,value:d.device,onChange:T=>y(l=>({...l,device:T.target.value})),error:p.device}),m&&e.jsxs(Z,{p:"md",withBorder:!0,bg:"gray.0",children:[e.jsx(c,{size:"sm",fw:500,mb:"xs",children:"使用中のレイアウト"}),e.jsxs(c,{size:"sm",c:"dimmed",children:[m.name," (",m.orientation==="landscape"?"横向き":m.orientation==="portrait-right"?"縦向き(右)":"縦向き(左)"," ","- ",m.regions.length,"リージョン)"]}),e.jsx(c,{size:"xs",c:"dimmed",mt:"xs",children:"※ レイアウトの変更はできません。新しいプレイリストを作成してください。"})]})]});case"content":return e.jsx(w,{style:{height:"100%"},children:m?m.regions.length===0?e.jsx(Z,{p:"md",withBorder:!0,children:e.jsx(c,{c:"dimmed",ta:"center",children:"このレイアウトにはリージョンがありません"})}):e.jsxs($,{align:"flex-start",gap:"lg",wrap:"nowrap",style:{height:"100%"},children:[e.jsx(w,{style:{flex:"1 1 auto",height:"100%",display:"flex",flexDirection:"column"},children:j?e.jsxs(e.Fragment,{children:[e.jsxs($,{justify:"space-between",mb:"sm",children:[e.jsxs(c,{fw:600,children:["リージョン ",m.regions.findIndex(T=>T.id===j)+1," ","のコンテンツを編集"]}),e.jsx(X,{variant:"light",size:"xs",leftSection:e.jsx(De,{size:14}),onClick:()=>v(!0),children:"コンテンツを追加"})]}),e.jsxs($,{gap:"md",mb:"md",children:[e.jsx(ze,{placeholder:"コンテンツを検索...",leftSection:e.jsx(rn,{size:16}),rightSection:K?e.jsx(X,{variant:"subtle",size:"xs",p:0,onClick:()=>se(""),miw:"auto",h:"auto",children:e.jsx(lt,{size:14})}):null,value:K,onChange:T=>se(T.target.value),flex:1,size:"sm"}),e.jsx(on,{value:H,onChange:T=>U(T),data:[{value:"all",label:e.jsxs($,{gap:4,align:"center",justify:"center",miw:"60px",wrap:"nowrap",children:[e.jsx(an,{size:14}),e.jsx(c,{size:"xs",children:"すべて"})]})},{value:"video",label:e.jsxs($,{gap:4,align:"center",justify:"center",miw:"60px",wrap:"nowrap",children:[e.jsx(ln,{size:14}),e.jsx(c,{size:"xs",children:"動画"})]})},{value:"image",label:e.jsxs($,{gap:4,align:"center",justify:"center",miw:"60px",wrap:"nowrap",children:[e.jsx(cn,{size:14}),e.jsx(c,{size:"xs",children:"画像"})]})},{value:"text",label:e.jsxs($,{gap:4,align:"center",justify:"center",miw:"60px",wrap:"nowrap",children:[e.jsx(dn,{size:14}),e.jsx(c,{size:"xs",children:"テキスト"})]})},{value:"youtube",label:e.jsxs($,{gap:4,align:"center",justify:"center",miw:"60px",wrap:"nowrap",children:[e.jsx(un,{size:14}),e.jsx(c,{size:"xs",children:"YouTube"})]})},{value:"url",label:e.jsxs($,{gap:4,align:"center",justify:"center",miw:"60px",wrap:"nowrap",children:[e.jsx(hn,{size:14}),e.jsx(c,{size:"xs",children:"URL"})]})}],size:"xs",style:{fontSize:"11px"}})]}),e.jsx(vt,{style:{flex:1},type:"auto",children:(()=>{var l;const T=Ke();return g.length===0?e.jsxs(Z,{p:"xl",withBorder:!0,style:{textAlign:"center"},children:[e.jsx(c,{c:"dimmed",mb:"sm",children:"利用可能なコンテンツがありません"}),e.jsx(c,{size:"sm",c:"dimmed",mb:"md",children:"先にコンテンツを追加してください"}),e.jsx(X,{variant:"filled",leftSection:e.jsx(De,{size:16}),onClick:()=>v(!0),children:"コンテンツを追加"})]}):T.length===0?e.jsxs(Z,{p:"xl",withBorder:!0,style:{textAlign:"center"},children:[e.jsx(c,{c:"dimmed",mb:"sm",children:"条件に一致するコンテンツがありません"}),e.jsx(c,{size:"sm",c:"dimmed",children:"フィルターや検索条件を変更してください"})]}):e.jsx(Jt,{contents:T,selectedContentIds:((l=pe())==null?void 0:l.contentIds)||[],onSelectionChange:async C=>{j&&await Le(j,C)},loading:!1,maxItems:20})})()})]}):e.jsxs(Z,{p:"xl",withBorder:!0,style:{textAlign:"center",height:"100%",display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(c,{c:"dimmed",mb:"sm",children:"右のレイアウトプレビューからリージョンを選択してください"}),e.jsx(c,{size:"sm",c:"dimmed",children:"選択したリージョンのコンテンツを編集できます"})]})}),e.jsx(w,{style:{flex:"0 0 400px",minWidth:"400px",height:"100%",display:"flex",flexDirection:"column"},children:e.jsxs(ne,{gap:"lg",style:{height:"100%"},children:[e.jsxs(w,{children:[e.jsx(c,{fw:600,mb:"sm",children:"レイアウトプレビュー"}),e.jsx(Qt,{layout:m,selectedRegionId:j,onRegionClick:we,assignedContentCounts:qe(),canvasWidth:380,canvasHeight:214})]}),j&&e.jsxs(w,{style:{flex:1,display:"flex",flexDirection:"column",minHeight:0},children:[e.jsx(c,{fw:600,mb:"sm",children:"順序変更"}),e.jsx(vt,{style:{flex:1,minHeight:0},type:"auto",scrollbarSize:8,children:e.jsx(qt,{selectedContents:((x=pe())==null?void 0:x.contentIds.map(T=>g.find(l=>l.id===T)).filter(Boolean))||[],onReorder:T=>{j&&Re(j,T)},contentDurations:(F=(R=pe())==null?void 0:R.contentDurations)==null?void 0:F.reduce((T,l)=>(T[l.contentId]=l.duration,T),{})})})]})]})})]}):e.jsx(c,{c:"dimmed",children:"レイアウト情報を読み込み中..."})});default:return null}},ot=()=>u==="content"?"95%":"lg",Me=()=>{if(u==="content")return{content:{maxWidth:"1600px",minWidth:"1200px",height:"900px",maxHeight:"95vh"},body:{height:"calc(900px - 60px)",padding:0,overflow:"hidden",display:"flex",flexDirection:"column"}}};return e.jsxs(e.Fragment,{children:[e.jsx(Oe,{opened:t,onClose:Te,title:"プレイリストを編集",centered:!0,size:ot(),styles:Me(),children:e.jsxs(ne,{gap:"lg",style:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(w,{px:u==="content"?20:0,pt:u==="content"?20:0,children:[e.jsxs($,{justify:"space-between",mb:"xs",children:[e.jsx(c,{size:"sm",fw:500,children:ee[ae()].title}),e.jsxs(c,{size:"xs",c:"dimmed",children:[ae()+1," / ",ee.length]})]}),e.jsx(le,{value:He(),size:"sm"}),e.jsx(c,{size:"xs",c:"dimmed",mt:"xs",children:ee[ae()].description})]}),e.jsx(ct,{mx:u==="content"?20:0}),e.jsx(w,{style:{flex:1,overflow:"hidden",minHeight:0},px:u==="content"?20:0,children:rt()}),e.jsxs($,{justify:"space-between",mt:u==="content"?"sm":"lg",px:u==="content"?20:0,pb:u==="content"?16:0,children:[e.jsxs($,{children:[e.jsx(X,{variant:"subtle",leftSection:e.jsx(lt,{size:16}),onClick:Te,disabled:h,children:"キャンセル"}),et()&&e.jsx(X,{variant:"light",leftSection:e.jsx(Ht,{size:16}),onClick:Je,disabled:h,children:"戻る"})]}),e.jsx($,{children:Ze()?e.jsx(X,{rightSection:e.jsx(Wt,{size:16}),onClick:xe,disabled:h,children:"次へ"}):e.jsx(X,{leftSection:e.jsx(ht,{size:16}),onClick:Ee,loading:h,children:"更新"})})]})]})}),e.jsx(Lt,{opened:A,onClose:()=>v(!1),onFileSubmit:tt,onUrlSubmit:nt,onRichTextSubmit:st}),E&&e.jsx(Kt,{opened:O,onClose:ye,contentName:E.contentName,contentType:E.contentType,currentDuration:j?Xe(j,E.contentId):void 0,onSubmit:Qe,onCancel:ye})]})};function ds({progressInfos:t,playlistName:n}){const r=t.length>0?t.reduce((o,u)=>o+u.totalProgress,0)/t.length:0,i=t.length>0?Math.max(...t.map(o=>o.remainingTime)):0,h=o=>{const u=Math.floor(o/60),s=Math.floor(o%60);return`${u}:${s.toString().padStart(2,"0")}`};return e.jsx(w,{w:300,p:"md",style:{borderLeft:"1px solid #e9ecef"},children:e.jsxs(ne,{gap:"lg",children:[e.jsxs(w,{children:[e.jsx(c,{size:"lg",fw:600,mb:"xs",children:n}),e.jsxs($,{justify:"space-between",mb:"xs",children:[e.jsx(c,{size:"sm",c:"dimmed",children:"全体の進行状況"}),e.jsxs(c,{size:"sm",c:"dimmed",children:["残り ",h(i)]})]}),e.jsx(le,{value:r,size:"lg"})]}),e.jsxs(ne,{gap:"md",children:[e.jsx(c,{size:"md",fw:500,children:"リージョン別進行状況"}),t.map((o,u)=>e.jsxs(w,{p:"sm",style:{backgroundColor:"#f8f9fa",borderRadius:"6px",border:"1px solid #e9ecef"},children:[e.jsxs($,{justify:"space-between",mb:"xs",children:[e.jsxs(c,{size:"sm",fw:500,children:["リージョン ",u+1]}),e.jsxs(c,{size:"xs",c:"dimmed",children:[o.currentContentIndex+1," / ",o.regionId?"複数":"1"]})]}),e.jsx(c,{size:"sm",mb:"xs",truncate:!0,children:o.currentContentName}),e.jsxs($,{justify:"space-between",mb:"xs",children:[e.jsx(c,{size:"xs",c:"dimmed",children:"進行状況"}),e.jsxs(c,{size:"xs",c:"dimmed",children:["残り ",h(o.remainingTime)]})]}),e.jsx(le,{value:o.totalProgress,size:"sm",mb:"xs"}),e.jsxs($,{justify:"space-between",mb:"4",children:[e.jsx(c,{size:"xs",c:"dimmed",children:"現在のコンテンツ"}),e.jsxs(c,{size:"xs",c:"dimmed",children:[Math.round(o.currentContentProgress),"%"]})]}),e.jsx(le,{value:o.currentContentProgress,size:"xs"})]},o.regionId))]}),e.jsxs(w,{style:{backgroundColor:"#e3f2fd",padding:"12px",borderRadius:"6px",border:"1px solid #bbdefb"},children:[e.jsx(c,{size:"sm",fw:500,mb:"xs",children:"統計情報"}),e.jsxs($,{justify:"space-between",children:[e.jsx(c,{size:"xs",c:"dimmed",children:"リージョン数"}),e.jsx(c,{size:"xs",children:t.length})]}),e.jsxs($,{justify:"space-between",children:[e.jsx(c,{size:"xs",c:"dimmed",children:"総コンテンツ数"}),e.jsx(c,{size:"xs",children:t.reduce((o,u)=>o+(u.currentContentIndex+1),0)})]}),e.jsxs($,{justify:"space-between",children:[e.jsx(c,{size:"xs",c:"dimmed",children:"全体の進行率"}),e.jsxs(c,{size:"xs",children:[Math.round(r),"%"]})]})]})]})})}const us=a.memo(function({content:n,duration:r,onComplete:i,onProgress:h,width:o,height:u}){const[,s]=a.useState(0),d=a.useRef(null),y=a.useRef(null),[p,I]=a.useState(null),[m,f]=a.useState(null);a.useEffect(()=>{if(s(0),n.type==="video"&&y.current){const P=y.current,S=()=>{if(P.duration){const A=P.currentTime/P.duration*100;s(A),h==null||h(A)}},D=()=>{s(100),h==null||h(100),i==null||i()};return P.addEventListener("timeupdate",S),P.addEventListener("ended",D),()=>{P.removeEventListener("timeupdate",S),P.removeEventListener("ended",D)}}const k=Date.now(),j=()=>{const P=(Date.now()-k)/1e3,S=Math.min(P/r*100,100);s(S),h==null||h(S),S>=100&&(i==null||i())};return d.current=window.setInterval(j,100),()=>{d.current&&clearInterval(d.current)}},[n,r,i,h]),a.useEffect(()=>{const k=async()=>{if((n.type==="video"||n.type==="image")&&n.fileInfo)try{const P=await xn.getInstance().readFile(n.fileInfo.storagePath),S=new Blob([P],{type:n.fileInfo.mimeType}),D=URL.createObjectURL(S);n.type==="video"?I(D):f(D)}catch(j){J.error("ContentRenderer",`Failed to load file: ${n.fileInfo.storagePath}`,j)}};I(null),f(null),k()},[n.type,n.fileInfo]),a.useEffect(()=>()=>{p&&URL.revokeObjectURL(p),m&&URL.revokeObjectURL(m)},[p,m]);const g=()=>{var j,P;const k={width:"100%",height:"100%",objectFit:"contain"};switch(n.type){case"video":return e.jsx("video",{ref:y,src:p||void 0,style:k,autoPlay:!0,muted:!0,playsInline:!0,loop:!0});case"image":return e.jsx("img",{src:m||void 0,alt:n.name,style:k});case"rich-text":return n.richTextInfo?e.jsx(hs,{richText:n.richTextInfo,width:o,height:u}):null;case"youtube":{if(!((j=n.urlInfo)!=null&&j.url))return null;const S=ut(n.urlInfo.url);return S?e.jsx("iframe",{src:`https://www.youtube.com/embed/${S}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&loop=1&playlist=${S}`,style:{width:"100%",height:"100%",border:"none"},allow:"autoplay; encrypted-media",title:n.name}):null}case"url":return(P=n.urlInfo)!=null&&P.url?e.jsx("iframe",{src:n.urlInfo.url,style:{width:"100%",height:"100%",border:"none"},title:n.name}):null;default:return e.jsx(c,{children:"サポートされていないコンテンツタイプです"})}};return e.jsx(w,{style:{width:o,height:u,position:"relative",overflow:"hidden"},children:g()})});function hs({richText:t,width:n,height:r}){const i=a.useRef(null);a.useEffect(()=>{const o=i.current;if(!o||t.scrollType==="none")return;const u=t.scrollType==="horizontal"?o.scrollWidth-n:o.scrollHeight-r,s=u/t.scrollSpeed*1e3;let d;const y=p=>{d||(d=p);const I=p-d,m=Math.min(I/s,1);t.scrollType==="horizontal"?o.scrollLeft=m*u:o.scrollTop=m*u,m<1&&requestAnimationFrame(y)};requestAnimationFrame(y)},[t,n,r]);const h={fontFamily:t.fontFamily,fontSize:`${t.fontSize}px`,color:t.color,backgroundColor:t.backgroundColor,textAlign:t.textAlign,writingMode:t.writingMode==="vertical"?"vertical-rl":"horizontal-tb",whiteSpace:t.scrollType!=="none"?"nowrap":"pre-wrap",padding:"16px",width:t.scrollType==="horizontal"?"max-content":"100%",height:t.scrollType==="vertical"?"max-content":"100%",minHeight:"100%",display:"flex",alignItems:t.scrollType==="none"?"center":"flex-start",justifyContent:t.textAlign==="center"?"center":t.textAlign==="end"?"flex-end":"flex-start"};return e.jsx(w,{ref:i,style:{width:n,height:r,overflow:t.scrollType!=="none"?"hidden":"auto",backgroundColor:t.backgroundColor},children:e.jsx(w,{style:h,children:t.content})})}const ms=a.memo(function({region:n,assignment:r,onProgress:i}){const{getContentById:h}=dt(),[o,u]=a.useState(0),[s,d]=a.useState([]),[y,p]=a.useState([]),[I,m]=a.useState(!1),[f,g]=a.useState(0);a.useEffect(()=>{const E=async()=>{try{const b=[];for(const z of r.contentIds){const G=await h(z);G?b.push(G):J.warn("RegionPlayer",`Content not found: ${z}`)}d(b),p(r.contentDurations),u(0),g(0),m(!0)}catch(b){J.error("RegionPlayer","Failed to load contents",b)}};r.contentIds.length>0?E():(g(0),m(!0))},[r,h]);const k=a.useCallback(()=>{var z,G;if(o>=s.length)return 0;const E=s[o],b=y.find(H=>H.contentId===E.id);return b?b.duration:E.type==="video"&&((G=(z=E.fileInfo)==null?void 0:z.metadata)!=null&&G.duration)?E.fileInfo.metadata.duration:10},[o,s,y]),j=a.useCallback(()=>s.reduce((E,b,z)=>{var H,U;const G=y.find(K=>K.contentId===b.id);return G?E+G.duration:b.type==="video"&&((U=(H=b.fileInfo)==null?void 0:H.metadata)!=null&&U.duration)?E+b.fileInfo.metadata.duration:E+10},0),[s,y]),P=a.useCallback(()=>{var b,z;let E=0;for(let G=0;G<o;G++){const H=s[G],U=y.find(K=>K.contentId===H.id);U?E+=U.duration:H.type==="video"&&((z=(b=H.fileInfo)==null?void 0:b.metadata)!=null&&z.duration)?E+=H.fileInfo.metadata.duration:E+=10}return E},[o,s,y]),S=a.useCallback(()=>{u(E=>E>=s.length-1?0:E+1),g(0)},[s.length]),D=a.useCallback(E=>{g(E)},[]),A=a.useMemo(()=>j(),[j]),v=a.useMemo(()=>P(),[P]);if(a.useEffect(()=>{if(!I||s.length===0)return;const E=s[o];if(!E)return;const b={regionId:n.id,currentContentIndex:o,currentContentName:E.name,currentContentProgress:f,totalProgress:A>0?v/A*100:0,remainingTime:A-v,totalDuration:A};i==null||i(b)},[o,s,n.id,I,i,A,v,f]),!I)return e.jsx(w,{style:{position:"absolute",left:n.x,top:n.y,width:n.width,height:n.height,zIndex:n.zIndex,backgroundColor:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center"},children:"読み込み中..."});if(s.length===0)return e.jsx(w,{style:{position:"absolute",left:n.x,top:n.y,width:n.width,height:n.height,zIndex:n.zIndex,backgroundColor:"#f8f9fa",border:"2px dashed #dee2e6",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",color:"#868e96"},children:"コンテンツが設定されていません"});const O=s[o],Y=k();return e.jsx(w,{style:{position:"absolute",left:n.x,top:n.y,width:n.width,height:n.height,zIndex:n.zIndex,overflow:"hidden"},children:e.jsx(us,{content:O,duration:Y,onComplete:S,onProgress:D,width:n.width,height:n.height})})});function xs({opened:t,onClose:n,playlistId:r}){const{getPlaylistById:i}=Rt(),{getLayoutById:h}=Ge(),[o,u]=a.useState(null),[s,d]=a.useState(null),[y,p]=a.useState(!1),[I,m]=a.useState(null),[f,g]=a.useState([]);a.useEffect(()=>{t&&r&&(async()=>{if(r){p(!0),m(null);try{const A=await i(r);if(!A)throw new Error("プレイリストが見つかりません");u(A);const v=await h(A.layoutId);if(!v)throw new Error("レイアウトが見つかりません");d(v),g([])}catch(A){J.error("PlaylistPreviewModal","Failed to load playlist data",A),m(A instanceof Error?A.message:"データの読み込みに失敗しました")}finally{p(!1)}}})()},[t,r,i,h]);const k=a.useCallback(D=>{g(A=>{const v=A.findIndex(O=>O.regionId===D.regionId);if(v>=0){const O=[...A];return O[v]=D,O}return[...A,D]})},[]),j=a.useMemo(()=>{if(!s)return{width:800,height:600,scale:1};const D=1920,A=1080;let v,O;s.orientation==="portrait-right"||s.orientation==="portrait-left"?(v=A,O=D):(v=D,O=A);const Y=800,E=600,b=Y/v,z=E/O,G=Math.min(b,z);return{width:v*G,height:O*G,scale:G}},[s]),P=a.useMemo(()=>!s||!o?[]:s.regions.map((D,A)=>{const v=o.contentAssignments.find(Y=>Y.regionId===D.id),O={...D,x:D.x*j.scale,y:D.y*j.scale,width:D.width*j.scale,height:D.height*j.scale};return v?e.jsx(ms,{region:O,assignment:v,onProgress:k},D.id):e.jsxs(w,{style:{position:"absolute",left:O.x,top:O.y,width:O.width,height:O.height,zIndex:D.zIndex,backgroundColor:"#f8f9fa",border:"2px dashed #dee2e6",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",color:"#868e96"},children:["リージョン ",A+1,e.jsx("br",{}),"(コンテンツ未設定)"]},D.id)}),[s,o,j.scale,k]),S=()=>{u(null),d(null),g([]),m(null),n()};return t?e.jsxs(Oe,{opened:t,onClose:S,title:"プレイリストプレビュー",size:"calc(100vw - 40px)",styles:{content:{height:"calc(100vh - 80px)"},body:{height:"100%",padding:0}},children:[e.jsx(_t,{visible:y}),e.jsxs(w,{style:{height:"100%",display:"flex"},children:[e.jsx(w,{style:{flex:1,padding:"20px",overflow:"auto"},children:I?e.jsxs(ne,{align:"center",justify:"center",style:{height:"100%"},children:[e.jsx(c,{c:"red",children:I}),e.jsx(X,{onClick:S,children:"閉じる"})]}):o&&s?e.jsx(w,{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(w,{style:{position:"relative",width:j.width,height:j.height,border:"2px solid #dee2e6",borderRadius:"8px",backgroundColor:"#ffffff",overflow:"hidden"},children:P})}):e.jsx(ne,{align:"center",justify:"center",style:{height:"100%"},children:e.jsx(c,{children:"プレイリストを読み込み中..."})})}),o&&e.jsx(ds,{progressInfos:f,playlistName:o.name})]})]}):null}const Se=Ye([]),Zt=Ye(!1),en=Ye(null),fs=Ye(null,(t,n,r)=>{switch(r.type){case"SET_PLAYLISTS":n(Se,r.playlists);break;case"SET_LOADING":n(Zt,r.loading);break;case"SET_ERROR":n(en,r.error);break;case"ADD_PLAYLIST":n(Se,i=>[...i,r.playlist]);break;case"UPDATE_PLAYLIST":n(Se,i=>i.map(h=>h.id===r.playlist.id?r.playlist:h));break;case"REMOVE_PLAYLIST":n(Se,i=>i.filter(h=>h.id!==r.id));break}}),Ts=tn(function(){const[n]=de(Se),[r]=de(Zt),[i]=de(en),[h]=de(En),[o]=de(Tn),[u]=de(Ln),[,s]=de(fs),[,d]=de(Rn),{getPlaylistsIndex:y,deletePlaylist:p,createPlaylist:I,getPlaylistById:m,updatePlaylist:f}=Rt();a.useEffect(()=>{(async()=>{s({type:"SET_LOADING",loading:!0}),s({type:"SET_ERROR",error:null});try{const z=await y();s({type:"SET_PLAYLISTS",playlists:z})}catch(z){s({type:"SET_ERROR",error:z instanceof Error?z.message:"不明なエラーが発生しました"})}finally{s({type:"SET_LOADING",loading:!1})}})()},[y,s]);const g=b=>{d({type:"OPEN_PLAYLIST_EDIT",playlistId:b})},k=b=>{d({type:"OPEN_PLAYLIST_PREVIEW",playlistId:b})},j=async b=>{Ne.openConfirmModal({title:"プレイリストを削除",children:e.jsx(c,{size:"sm",children:"このプレイリストを削除しますか？この操作は元に戻せません。"}),labels:{confirm:"削除",cancel:"キャンセル"},confirmProps:{color:"red"},onConfirm:async()=>{try{await p(b),s({type:"REMOVE_PLAYLIST",id:b})}catch(z){s({type:"SET_ERROR",error:z instanceof Error?z.message:"削除に失敗しました"})}}})},P=()=>{d({type:"OPEN_PLAYLIST_CREATE"})},S=async b=>{try{const z=await I({name:b.name,layoutId:b.layoutId,contentAssignments:b.contentAssignments,device:b.device}),G={id:z.id,name:z.name,layoutId:z.layoutId,contentCount:z.contentAssignments.reduce((H,U)=>H+U.contentIds.length,0),device:z.device,createdAt:z.createdAt,updatedAt:z.updatedAt};s({type:"ADD_PLAYLIST",playlist:G})}catch(z){throw s({type:"SET_ERROR",error:z instanceof Error?z.message:"プレイリストの作成に失敗しました"}),z}},D=()=>{d({type:"CLOSE_PLAYLIST_CREATE"})},A=()=>{d({type:"CLOSE_PLAYLIST_EDIT"})},v=()=>{d({type:"CLOSE_PLAYLIST_PREVIEW"})},O=async b=>{if(o.playlistId)try{await f(o.playlistId,{name:b.name,device:b.device,contentAssignments:b.contentAssignments});const z=await y();s({type:"SET_PLAYLISTS",playlists:z})}catch(z){throw s({type:"SET_ERROR",error:z instanceof Error?z.message:"プレイリストの更新に失敗しました"}),z}},[Y,E]=a.useState(null);return a.useEffect(()=>{(async()=>{if(o.opened&&o.playlistId)try{const z=await m(o.playlistId);E(z)}catch(z){s({type:"SET_ERROR",error:z instanceof Error?z.message:"プレイリストの読み込みに失敗しました"}),d({type:"CLOSE_PLAYLIST_EDIT"})}})()},[o.opened,o.playlistId,m,s,d]),e.jsxs(w,{pos:"relative",children:[e.jsx(_t,{visible:r}),i&&!i.includes("Failed to read JSON")&&e.jsx(_n,{icon:e.jsx(Nn,{size:16}),color:"red",mb:"md",children:i}),e.jsx($,{justify:"flex-end",mb:"md",children:e.jsx(X,{leftSection:e.jsx(De,{size:16}),onClick:P,children:"新しいプレイリストを作成"})}),e.jsxs(Q,{striped:!0,highlightOnHover:!0,children:[e.jsx(Q.Thead,{children:e.jsxs(Q.Tr,{children:[e.jsx(Q.Th,{children:"操作"}),e.jsx(Q.Th,{children:"名前"}),e.jsx(Q.Th,{children:"コンテンツ数"}),e.jsx(Q.Th,{children:"デバイス"}),e.jsx(Q.Th,{children:"作成日時"}),e.jsx(Q.Th,{children:"操作"})]})}),e.jsx(Q.Tbody,{children:n.length===0&&!r?e.jsx(Q.Tr,{children:e.jsx(Q.Td,{colSpan:6,ta:"center",c:"dimmed",children:"プレイリストがありません"})}):n.map(b=>e.jsxs(Q.Tr,{children:[e.jsx(Q.Td,{children:e.jsxs($,{gap:"xs",children:[e.jsx(it,{variant:"subtle",color:"blue",size:"sm",onClick:()=>g(b.id),"aria-label":"編集",children:e.jsx(fn,{size:16})}),e.jsx(it,{variant:"subtle",color:"green",size:"sm",onClick:()=>k(b.id),"aria-label":"プレビュー",children:e.jsx(Pn,{size:16})})]})}),e.jsx(Q.Td,{children:e.jsx(c,{fw:500,children:b.name})}),e.jsx(Q.Td,{children:e.jsx(c,{children:b.contentCount})}),e.jsx(Q.Td,{children:e.jsx(c,{children:b.device})}),e.jsx(Q.Td,{children:e.jsx(c,{children:new Date(b.createdAt).toLocaleString("ja-JP")})}),e.jsx(Q.Td,{children:e.jsx(it,{variant:"subtle",color:"red",size:"sm",onClick:()=>j(b.id),"aria-label":"削除",children:e.jsx(gn,{size:16})})})]},b.id))})]}),e.jsx(ls,{opened:h,onClose:D,onSubmit:S}),e.jsx(cs,{opened:o.opened,onClose:A,onSubmit:O,playlist:Y}),e.jsx(xs,{opened:u.opened,onClose:v,playlistId:u.playlistId})]})});export{Ts as default};
