import{a as h,w as Ue}from"./chunk-QMGIS6GS-npKyu-26.js";import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{C as ke,a as _e}from"./ContentGridView-Dtgkrepm.js";import{b as ue,l as Oe,m as Be,d as ye,j as je,i as Te,h as fe,g as Se,f as Ee,k as ze,T as me,F as Le,n as we,c as $e}from"./ContentAddModal-C_1kSIvW.js";import{H as xe,I as Ne,B as ie}from"./IconList-DDBipvuP.js";import{B as w,C as $}from"./react-Bl1EszzN.js";import{T as c,P as de,L as We,d as Q,B as W,A as ne}from"./TextInput-DMku8_7E.js";import{F as Ie,G as P,l as V,S as J,M as Re,n as le,N as Ce,I as He,j as Ge,k as Ae,m as Me,L as Ve}from"./layout-CG8-yu9n.js";import{u as Ye,a as Ze,I as qe,T as N,b as Je,f as Ke,m as Xe}from"./modal-DDjUobDH.js";import{A as pe,I as ve}from"./IconExclamationCircle-DgxA9N8q.js";import{a as be}from"./createReactComponent-Bo4FKQF2.js";import{I as Qe}from"./IconPlaylist-C2G4sW-m.js";import{D as De}from"./Divider-Dp5dI_5-.js";import{m as ge}from"./events-CgSWVLLi.js";import{f as et,c as tt,a as rt,b as st,d as nt,e as it,g as at,h as ot}from"./content-D7L0e-wr.js";import"./get-contrast-color-B-kutpjz.js";import"./use-delayed-hover-C8bZQnj-.js";import"./index-Bt7hW1Ho.js";import"./utils-BA-NeLEp.js";/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var lt=be("outline","alert-circle","IconAlertCircle",[["path",{d:"M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0",key:"svg-0"}],["path",{d:"M12 8v4",key:"svg-1"}],["path",{d:"M12 16h.01",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ct=be("outline","chevron-left","IconChevronLeft",[["path",{d:"M15 6l-6 6l6 6",key:"svg-0"}]]);/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var dt=be("outline","chevron-right","IconChevronRight",[["path",{d:"M9 6l6 6l-6 6",key:"svg-0"}]]);const ut=t=>{const x=/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,s=t.match(x);return s?s[1]:null},ht=({content:t,children:x,disabled:s=!1})=>{const[f,g]=h.useState({loading:!1}),{getThumbnailUrl:S}=ue(),I=400,r=225,d=h.useCallback(async()=>{try{const l=await S(t.id);if(l)g({loading:!1,previewUrl:l});else throw new Error("サムネイルが見つかりません")}catch{const v={video:"動画",image:"画像",text:"テキスト"},U={video:"#228be6",image:"#40c057",text:"#fd7e14"},M=v[t.type]||"ファイル",k=U[t.type]||"#6c757d";g({loading:!1,previewUrl:"data:image/svg+xml;base64,"+btoa(`
            <svg width="400" height="225" xmlns="http://www.w3.org/2000/svg">
              <rect width="100%" height="100%" fill="${k}"/>
              <text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="white" font-size="16">
                ${M}プレビュー
              </text>
            </svg>
          `)})}},[t.id,t.type,S]),R=h.useCallback(async()=>{try{if(!t.url)throw new Error("YouTube URL が見つかりません");const l=ut(t.url);if(l)g({loading:!1,previewUrl:`https://img.youtube.com/vi/${l}/mqdefault.jpg`});else throw new Error("YouTube動画IDの抽出に失敗")}catch{g({loading:!1,error:"YouTubeプレビュー生成に失敗"})}},[t.url]),_=h.useCallback(async()=>{try{g({loading:!1,previewUrl:"data:image/svg+xml;base64,"+btoa(`
          <svg width="400" height="225" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#7950f2"/>
            <text x="50%" y="30%" text-anchor="middle" dy=".3em" fill="white" font-size="14">
              Webページ
            </text>
            <text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="white" font-size="12">
              ${new URL(t.url||"").hostname}
            </text>
            <text x="50%" y="70%" text-anchor="middle" dy=".3em" fill="white" font-size="10">
              クリックしてアクセス
            </text>
          </svg>
        `)})}catch{g({loading:!1,error:"URLプレビュー生成に失敗"})}},[t.url]),p=h.useCallback(async()=>{g({loading:!0});try{switch(t.type){case"video":case"image":case"text":await d();break;case"youtube":await R();break;case"url":await _();break;default:g({loading:!1,error:"Unknown content type"})}}catch(l){console.error("Preview generation failed:",l),g({loading:!1,error:l instanceof Error?l.message:"プレビュー生成に失敗しました"})}},[t.type,d,R,_]);h.useEffect(()=>{s||p()},[p,s]);const y=l=>{const v={size:14};switch(l){case"video":return e.jsx(Ee,{...v});case"image":return e.jsx(Se,{...v});case"text":return e.jsx(fe,{...v});case"youtube":return e.jsx(Te,{...v});case"url":return e.jsx(je,{...v});default:return e.jsx(ye,{...v})}},F=l=>{switch(l){case"video":return"blue";case"image":return"green";case"text":return"orange";case"youtube":return"red";case"url":return"purple";default:return"gray"}},A=l=>{if(!l)return"";if(l===0)return"0 B";const v=1024,U=["B","KB","MB","GB"],M=Math.floor(Math.log(l)/Math.log(v));return`${Number.parseFloat((l/v**M).toFixed(1))} ${U[M]}`},z=t.type==="video"||t.type==="image"||t.type==="youtube";if(s||!z)return e.jsx(e.Fragment,{children:x});const C=()=>f.loading?e.jsx(w,{w:I,h:300,style:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(c,{size:"sm",c:"dimmed",children:"読み込み中..."})}):f.error?e.jsxs(w,{w:I,h:300,style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[y(t.type),e.jsx(c,{size:"xs",c:"dimmed",mt:"xs",ta:"center",children:"プレビュー未対応"})]}):e.jsxs(de,{withBorder:!0,p:0,w:I,children:[e.jsxs(w,{pos:"relative",children:[e.jsx(w,{style:{height:r,width:"100%",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f8f9fa"},children:e.jsx(Oe,{src:f.previewUrl,alt:t.name,style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"},fallbackSrc:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIyNSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjFmM2Y0Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjOWNhM2FmIiBmb250LXNpemU9IjE2Ij5ObyBQcmV2aWV3PC90ZXh0Pjwvc3ZnPg=="})}),(t.type==="video"||t.type==="youtube")&&e.jsx(Ie,{pos:"absolute",top:"50%",left:"50%",style:{transform:"translate(-50%, -50%)",borderRadius:"50%"},bg:"rgba(0, 0, 0, 0.7)",p:"8px",align:"center",justify:"center",children:e.jsx(Be,{size:32,color:"white"})}),e.jsx(Ie,{pos:"absolute",top:"4px",left:"4px",bg:`${F(t.type)}.6`,c:"white",p:"2px 6px",style:{borderRadius:"4px",fontSize:"10px"},align:"center",gap:"4px",children:y(t.type)})]}),e.jsxs(w,{p:"md",children:[e.jsx(c,{size:"md",fw:600,lineClamp:1,mb:"xs",children:t.name}),e.jsxs(P,{justify:"space-between",mb:"xs",children:[t.size&&e.jsx(c,{size:"xs",c:"dimmed",children:A(t.size)}),t.url&&!t.size&&e.jsx(c,{size:"xs",c:"dimmed",lineClamp:1,maw:"120px",children:new URL(t.url).hostname}),e.jsx(c,{size:"xs",c:"dimmed",children:new Date(t.createdAt).toLocaleDateString("ja-JP")})]}),t.tags.length>0&&e.jsxs(P,{gap:4,children:[t.tags.slice(0,3).map(l=>e.jsx(c,{size:"xs",bg:"gray.1",c:"gray.7",style:{padding:"2px 6px",borderRadius:"4px"},children:l},l)),t.tags.length>3&&e.jsxs(c,{size:"xs",c:"dimmed",children:["+",t.tags.length-3]})]})]})]});return e.jsxs(xe,{width:I,shadow:"md",openDelay:300,closeDelay:100,position:"right",withArrow:!0,children:[e.jsx(xe.Target,{children:x}),e.jsx(xe.Dropdown,{p:0,children:C()})]})},xt=({contentId:t})=>{const[x,s]=h.useState(!0),[f,g]=h.useState(null),[S,I]=h.useState([]),{getPlaylistsIndex:r,getPlaylistById:d}=ze(),{getLayoutById:R}=Ye(),_=h.useCallback(async()=>{try{s(!0),g(null);const p=await r(),y=[];for(const F of p)try{const A=await d(F.id);if(!A)continue;const z=[];for(const C of A.contentAssignments){const l=C.contentIds.filter(v=>v===t).length;if(l>0){let v=`リージョン ${C.regionId}`;try{const U=await R(A.layoutId);U&&U.regions.find(k=>k.id===C.regionId)&&(v=`リージョン ${U.regions.findIndex(B=>B.id===C.regionId)+1}`)}catch(U){V.warn("ContentUsageDisplay","Failed to load layout for region name",U)}z.push({regionId:C.regionId,regionName:v,usageCount:l})}}if(z.length>0){let C=null;try{C=await R(A.layoutId)}catch(l){V.warn("ContentUsageDisplay","Failed to load layout",l)}y.push({playlist:F,layout:C,regionUsage:z})}}catch(A){V.warn("ContentUsageDisplay",`Failed to load playlist ${F.id}`,A)}I(y)}catch(p){V.error("ContentUsageDisplay","Failed to load content usage",p),g("使用状況の読み込みに失敗しました")}finally{s(!1)}},[t,r,d,R]);return h.useEffect(()=>{t&&_()},[t,_]),x?e.jsxs(w,{children:[e.jsx(c,{size:"sm",fw:500,mb:"sm",children:"使用状況"}),e.jsx(de,{p:"md",withBorder:!0,children:e.jsxs(P,{gap:"sm",children:[e.jsx(We,{size:"sm"}),e.jsx(c,{size:"sm",c:"dimmed",children:"使用状況を確認中..."})]})})]}):f?e.jsxs(w,{children:[e.jsx(c,{size:"sm",fw:500,mb:"sm",children:"使用状況"}),e.jsx(pe,{icon:e.jsx(lt,{size:16}),color:"red",children:f})]}):S.length===0?e.jsxs(w,{children:[e.jsx(c,{size:"sm",fw:500,mb:"sm",children:"使用状況"}),e.jsx(de,{p:"md",withBorder:!0,children:e.jsxs(P,{gap:"sm",children:[e.jsx(w,{c:"dimmed",children:e.jsx(Ne,{size:16})}),e.jsx(c,{size:"sm",c:"dimmed",children:"このコンテンツはどのプレイリストでも使用されていません"})]})})]}):e.jsxs(w,{children:[e.jsxs(P,{gap:"sm",mb:"sm",children:[e.jsx(c,{size:"sm",fw:500,children:"使用状況"}),e.jsxs(ie,{variant:"light",size:"sm",children:[S.length,"個のプレイリスト"]})]}),e.jsx(J,{gap:"sm",children:S.map(p=>e.jsx(de,{p:"md",withBorder:!0,children:e.jsxs(J,{gap:"xs",children:[e.jsxs(P,{gap:"sm",wrap:"nowrap",children:[e.jsx(w,{c:"blue.6",children:e.jsx(Qe,{size:16})}),e.jsxs(w,{style:{flex:1,minWidth:0},children:[e.jsx(c,{size:"sm",fw:500,style:{wordBreak:"break-word"},children:p.playlist.name}),e.jsxs(c,{size:"xs",c:"dimmed",children:["デバイス: ",p.playlist.device]})]})]}),p.layout&&e.jsxs(c,{size:"xs",c:"dimmed",children:["レイアウト: ",p.layout.name," (",p.layout.orientation==="landscape"?"横向き":p.layout.orientation==="portrait-right"?"縦向き(右)":"縦向き(左)",")"]}),e.jsx(P,{gap:"xs",mt:"xs",children:p.regionUsage.map(y=>e.jsxs(ie,{variant:"light",size:"xs",color:"blue",children:[y.regionName,y.usageCount>1&&` (${y.usageCount}回)`]},y.regionId))})]})},p.playlist.id))})]})},ce=16,ft=8,mt=200,Pe=h.memo(({opened:t,onClose:x,content:s,onSubmit:f})=>{const{getContentById:g}=ue(),[S,I]=h.useState(!1),[r,d]=h.useState(""),[R,_]=h.useState(""),[p,y]=h.useState(""),[F,A]=h.useState("horizontal"),[z,C]=h.useState("Inter, sans-serif"),[l,v]=h.useState("start"),[U,M]=h.useState("#000000"),[k,B]=h.useState("#ffffff"),[L,H]=h.useState(ce),[K,Y]=h.useState("none"),[ee,Z]=h.useState(3),[te,G]=h.useState(""),[n,i]=h.useState("");h.useEffect(()=>{t||I(!1)},[t]),h.useEffect(()=>{if(!s)return;d(s.name),_(s.tags.join(", ")),(async()=>{try{const E=await g(s.id);if(s.type==="rich-text"&&(E!=null&&E.richTextInfo)){const{content:O,writingMode:T,fontFamily:re,textAlign:X,color:q,backgroundColor:se,fontSize:ae,scrollType:he,scrollSpeed:oe}=E.richTextInfo;y(O),A(T),C(re),v(X),M(q),B(se),H(ae),Y(he||"none"),Z(oe||3)}else s.type==="rich-text"?(y(""),A("horizontal"),C("Inter, sans-serif"),v("start"),M("#000000"),B("#ffffff"),H(ce),Y("none"),Z(3)):(s.type==="url"||s.type==="youtube")&&(E!=null&&E.urlInfo)?(G(E.urlInfo.title||""),i(E.urlInfo.description||"")):(s.type==="url"||s.type==="youtube")&&(G(""),i(""))}catch(E){console.error("Failed to load content details:",E),s.type==="rich-text"?(y(""),A("horizontal"),C("Inter, sans-serif"),v("start"),M("#000000"),B("#ffffff"),H(ce),Y("none"),Z(3)):(s.type==="url"||s.type==="youtube")&&(G(""),i(""))}})()},[s,g]);const o=()=>{S||x()},j=async()=>{if(r.trim()){I(!0);try{const u=R.split(",").map(O=>O.trim()).filter(O=>O.length>0),E={id:s.id,name:r.trim(),tags:u};s.type==="rich-text"?E.richTextInfo={content:p.trim(),writingMode:F,fontFamily:z,textAlign:l,color:U,backgroundColor:k,fontSize:L,scrollType:K,scrollSpeed:ee}:(s.type==="url"||s.type==="youtube")&&(E.urlInfo={title:te.trim()||void 0,description:n.trim()||void 0}),await f(E)}catch(u){console.error("Content edit failed:",u),I(!1)}}},D=r.trim().length>0,a=s.type==="rich-text",m=s.type==="url"||s.type==="youtube",b=s.type==="video"||s.type==="image"||s.type==="text";return e.jsx(Re,{opened:t,onClose:o,title:"コンテンツを編集",centered:!0,size:"lg",children:e.jsxs(J,{gap:"md",children:[e.jsx(Q,{label:"コンテンツ名 *",placeholder:"コンテンツの名前を入力してください",value:r,onChange:u=>d(u.currentTarget.value),required:!0,"aria-required":"true","aria-label":"コンテンツ名入力"}),e.jsx(Q,{label:"タグ",placeholder:"タグをカンマ区切りで入力してください（例: タグ1, タグ2, タグ3）",value:R,onChange:u=>_(u.currentTarget.value),"aria-label":"タグ入力"}),e.jsx(w,{children:e.jsxs(c,{size:"sm",fw:500,mb:"xs",children:["コンテンツタイプ: ",s.type]})}),b&&e.jsx(w,{p:"md",bg:"#f8f9fa",style:{borderRadius:"4px"},children:e.jsxs(c,{size:"sm",c:"dimmed",children:["ファイルコンテンツは名前とタグのみ編集可能です。",s.size&&` ファイルサイズ: ${pt(s.size)}`]})}),m&&e.jsxs(J,{gap:"md",children:[e.jsxs(w,{p:"md",bg:"#f8f9fa",style:{borderRadius:"4px"},children:[e.jsx(c,{size:"sm",fw:500,mb:"xs",children:"URL情報"}),s.url&&e.jsxs(c,{size:"sm",c:"dimmed",style:{wordBreak:"break-all"},children:["URL: ",s.url]})]}),e.jsx(Q,{label:"タイトル",placeholder:"カスタムタイトル（省略可）",value:te,onChange:u=>G(u.currentTarget.value)}),e.jsx(Q,{label:"説明",placeholder:"説明文（省略可）",value:n,onChange:u=>i(u.currentTarget.value)})]}),a&&e.jsxs(J,{gap:"md",children:[e.jsx(me,{label:"テキストコンテンツ",placeholder:"表示したいテキストを入力してください",required:!0,minRows:4,value:p,onChange:u=>y(u.currentTarget.value),"aria-required":"true","aria-label":"テキストコンテンツ入力"}),e.jsxs(P,{grow:!0,children:[e.jsx(le,{label:"書字方向",value:F,onChange:u=>A(u),data:[{value:"horizontal",label:"横書き"},{value:"vertical",label:"縦書き"}],"aria-label":"書字方向の選択"}),e.jsx(le,{label:"整列位置",value:l,onChange:u=>v(u),data:F==="horizontal"?[{value:"start",label:"左揃え"},{value:"center",label:"中央揃え"},{value:"end",label:"右揃え"}]:[{value:"start",label:"上揃え"},{value:"center",label:"中央揃え"},{value:"end",label:"下揃え"}]})]}),e.jsxs(P,{grow:!0,children:[e.jsx(le,{label:"フォント",value:z,onChange:u=>C(u||"Inter, sans-serif"),data:Le,searchable:!0}),e.jsx(Ce,{label:"フォントサイズ",value:L,onChange:u=>H(Number(u)||ce),min:ft,max:mt,suffix:"px"})]}),e.jsxs(P,{grow:!0,children:[e.jsx(we,{label:"文字色",value:U,onChange:M,format:"hex",swatches:["#000000","#ffffff","#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"]}),e.jsx(we,{label:"背景色",value:k,onChange:B,format:"hex",swatches:["#ffffff","#000000","#f5f5f5","#e5e5e5","#d4d4d4","#a3a3a3","#737373","#525252"]})]}),e.jsxs(P,{grow:!0,children:[e.jsx(le,{label:"スクロール方向",value:K,onChange:u=>Y(u),data:[{value:"none",label:"スクロールなし"},{value:"horizontal",label:"横スクロール"},{value:"vertical",label:"縦スクロール"}],"aria-label":"スクロール方向の選択"}),e.jsx(Ce,{label:"スクロール速度",value:ee,onChange:u=>Z(Number(u)||3),min:1,max:10,disabled:K==="none",description:"1: 遅い - 10: 速い"})]}),e.jsxs(w,{children:[e.jsx(c,{size:"sm",fw:500,mb:"xs",children:"プレビュー"}),e.jsx(w,{p:"md",style:{backgroundColor:k,border:"1px solid #e5e5e5",borderRadius:"4px",minHeight:"100px",writingMode:F==="vertical"?"vertical-rl":"horizontal-tb",textAlign:l,fontFamily:z,fontSize:`${L}px`,color:U,display:"flex",alignItems:F==="horizontal"?l==="start"?"flex-start":l==="center"?"center":"flex-end":"stretch",justifyContent:F==="vertical"?l==="start"?"flex-start":l==="center"?"center":"flex-end":"stretch"},children:p||"プレビューテキスト"})]})]}),e.jsx(De,{}),e.jsx(xt,{contentId:s.id}),e.jsxs(P,{justify:"flex-end",mt:"lg",children:[e.jsx(W,{variant:"subtle",onClick:o,disabled:S,children:"キャンセル"}),e.jsx(W,{leftSection:e.jsx(He,{size:16}),onClick:j,loading:S,disabled:!D,children:"保存"})]})]})})});Pe.displayName="ContentEditModal";const pt=t=>{if(t===0)return"0 B";const x=1024,s=["B","KB","MB","GB"],f=Math.floor(Math.log(t)/Math.log(x));return`${Number.parseFloat((t/x**f).toFixed(1))} ${s[f]}`},gt=({opened:t,onClose:x,contentId:s,allContents:f=[],onContentDeleted:g,onContentUpdated:S,onContentChange:I})=>{const[r,d]=h.useState(null),[R,_]=h.useState(!1),[p,y]=h.useState(null),[F,A]=h.useState(!1),[z,C]=h.useState({name:"",url:"",title:"",description:"",richTextContent:""}),{getContentById:l,updateContent:v,deleteContent:U}=ue();h.useEffect(()=>{if(!t||!s){d(null),y(null);return}(async()=>{var m,b,u,E,O;_(!0);try{const T=await l(s);if(d(T),T&&C({name:T.name,url:((m=T.urlInfo)==null?void 0:m.url)||"",title:((b=T.urlInfo)==null?void 0:b.title)||"",description:((u=T.urlInfo)==null?void 0:u.description)||"",richTextContent:((E=T.richTextInfo)==null?void 0:E.content)||""}),((T==null?void 0:T.type)==="image"||(T==null?void 0:T.type)==="video")&&(O=T.fileInfo)!=null&&O.storagePath)try{const X=await Ge.getInstance().readFile(T.fileInfo.storagePath);if(X){const q=new Blob([X],{type:T.fileInfo.mimeType}),se=URL.createObjectURL(q);y(se)}}catch(re){console.error("Failed to read file from OPFS:",re)}}catch(T){console.error("Failed to load content:",T)}finally{_(!1)}})()},[t,s,l]),h.useEffect(()=>()=>{p&&URL.revokeObjectURL(p)},[p]);const M=()=>{p&&(URL.revokeObjectURL(p),y(null)),x()},k=()=>{var a,m;if(R)return e.jsx(w,{style:{height:"400px",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(c,{children:"読み込み中..."})});if(!r)return e.jsx(w,{style:{height:"400px",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(c,{children:"コンテンツが見つかりません"})});if(r.type==="image"&&p)return e.jsx(w,{style:{textAlign:"center",maxHeight:"70vh",overflow:"hidden"},children:e.jsx("img",{src:p,alt:r.name,style:{maxWidth:"100%",maxHeight:"70vh",objectFit:"contain",borderRadius:"8px"}})});if(r.type==="video"&&p)return e.jsx(w,{style:{textAlign:"center",maxHeight:"70vh"},children:e.jsx("video",{src:p,controls:!0,autoPlay:!0,style:{maxWidth:"100%",maxHeight:"70vh",borderRadius:"8px"},children:e.jsx("track",{kind:"captions"})})});if(r.type==="youtube"&&((a=r.urlInfo)!=null&&a.url)){const b=yt(r.urlInfo.url);if(b)return e.jsx(w,{ta:"center",children:e.jsx("iframe",{width:"100%",height:"400",src:`https://www.youtube.com/embed/${b}?autoplay=1`,title:r.name,frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,style:{borderRadius:"8px"}})})}if(r.type==="rich-text"&&r.richTextInfo){const{content:b,writingMode:u,fontFamily:E,textAlign:O,color:T,backgroundColor:re,fontSize:X,scrollType:q="none",scrollSpeed:se=3}=r.richTextInfo,ae=b.replace(/\n/g," "),he=ae.length,oe=Math.max(400,Math.min(he*X*.6,1200)),Fe=q!=="none"?`@keyframes textScrollModal {
              0% { transform: translate${q==="horizontal"?"X":"Y"}(100%); }
              100% { transform: translate${q==="horizontal"?"X":"Y"}(calc(-100% - ${oe}px)); }
            }`:"";return e.jsxs(w,{style:{minHeight:"400px",backgroundColor:re,border:"1px solid #e5e5e5",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:O==="center"?"center":O==="end"?"flex-end":"flex-start",overflow:"hidden",position:"relative",width:"100%",maxWidth:"100%"},children:[e.jsx("style",{children:Fe}),e.jsx("div",{style:{fontFamily:E,fontSize:`${X}px`,color:T,writingMode:u==="vertical"?"vertical-rl":"horizontal-tb",whiteSpace:"nowrap",padding:"20px",minWidth:`${oe}px`,width:"max-content",...q!=="none"?{animation:`textScrollModal ${11-se}s linear infinite`}:{}},children:ae})]})}return e.jsx(w,{style:{height:"400px",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs(J,{align:"center",gap:"md",children:[r.type==="url"?e.jsx(je,{size:48}):e.jsx(ye,{size:48}),e.jsx(c,{size:"lg",fw:500,children:r.name}),e.jsx(c,{size:"sm",c:"dimmed",children:"このコンテンツタイプはプレビューできません"}),((m=r.urlInfo)==null?void 0:m.url)&&e.jsx(c,{size:"sm",style:{wordBreak:"break-all"},children:r.urlInfo.url})]})})},B=()=>r?r.name:"コンテンツプレビュー",L=()=>!s||!f.length?-1:f.findIndex(a=>a.id===s),H=()=>L()>0,K=()=>{const a=L();return a>=0&&a<f.length-1},Y=()=>{const a=L();if(a>0){const m=f[a-1];I==null||I(m.id)}},ee=()=>{const a=L();if(a>=0&&a<f.length-1){const m=f[a+1];I==null||I(m.id)}},Z=()=>{A(!0)},te=()=>{var a,m,b,u;A(!1),r&&C({name:r.name,url:((a=r.urlInfo)==null?void 0:a.url)||"",title:((m=r.urlInfo)==null?void 0:m.title)||"",description:((b=r.urlInfo)==null?void 0:b.description)||"",richTextContent:((u=r.richTextInfo)==null?void 0:u.content)||""})},G=async()=>{if(r)try{const a={name:z.name};(r.type==="youtube"||r.type==="url")&&(a.urlInfo={url:z.url,title:z.title||void 0,description:z.description||void 0}),r.type==="rich-text"&&r.richTextInfo&&(a.richTextInfo={...r.richTextInfo,content:z.richTextContent}),await v(r.id,a),A(!1),S==null||S();const m=await l(r.id);d(m)}catch(a){console.error("Failed to update content:",a)}},n=()=>{r&&ge.openConfirmModal({title:"コンテンツを削除",children:e.jsx(c,{size:"sm",children:"このコンテンツを削除しますか？この操作は元に戻せません。"}),labels:{confirm:"削除",cancel:"キャンセル"},confirmProps:{color:"red"},onConfirm:async()=>{try{await U(r.id),g==null||g(),x()}catch(a){console.error("Failed to delete content:",a)}}})},i=()=>{if(!f.length||f.length<=1)return null;const a=L(),m=f.length;return e.jsxs(P,{justify:"space-between",align:"center",children:[e.jsx(ne,{variant:"light",disabled:!H(),onClick:Y,"aria-label":"前のコンテンツ",children:e.jsx(ct,{size:18})}),e.jsxs(c,{size:"sm",c:"dimmed",children:[a+1," / ",m]}),e.jsx(ne,{variant:"light",disabled:!K(),onClick:ee,"aria-label":"次のコンテンツ",children:e.jsx(dt,{size:18})})]})},o=()=>!F||!r?null:e.jsxs(J,{gap:"sm",children:[e.jsx(c,{size:"sm",fw:600,children:"コンテンツ情報を編集"}),e.jsx(Q,{label:"名前",value:z.name,onChange:a=>C(m=>({...m,name:a.target.value})),required:!0}),(r.type==="youtube"||r.type==="url")&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{label:"URL",value:z.url,onChange:a=>C(m=>({...m,url:a.target.value})),required:!0}),e.jsx(Q,{label:"タイトル",value:z.title,onChange:a=>C(m=>({...m,title:a.target.value}))}),e.jsx(me,{label:"説明",value:z.description,onChange:a=>C(m=>({...m,description:a.target.value})),rows:3})]}),r.type==="rich-text"&&e.jsx(me,{label:"テキストコンテンツ",value:z.richTextContent,onChange:a=>C(m=>({...m,richTextContent:a.target.value})),rows:6,placeholder:"表示したいテキストを入力してください",required:!0}),e.jsxs(P,{gap:"sm",mt:"sm",children:[e.jsx(W,{size:"sm",onClick:G,children:"保存"}),e.jsx(W,{size:"sm",variant:"light",onClick:te,children:"キャンセル"})]})]}),j=()=>F?null:e.jsxs(P,{justify:"space-between",children:[e.jsx(W,{variant:"light",leftSection:e.jsx(Ae,{size:16}),onClick:Z,children:"編集"}),e.jsx(W,{color:"red",variant:"light",leftSection:e.jsx(Me,{size:16}),onClick:n,children:"削除"})]}),D=()=>{var a,m,b,u,E,O,T;return r?e.jsxs(P,{gap:"xs",mt:"sm",children:[e.jsxs(c,{size:"sm",c:"dimmed",children:["タイプ: ",jt(r.type)]}),((a=r.fileInfo)==null?void 0:a.size)&&e.jsxs(c,{size:"sm",c:"dimmed",children:["サイズ: ",bt(r.fileInfo.size)]}),((b=(m=r.fileInfo)==null?void 0:m.metadata)==null?void 0:b.width)&&((E=(u=r.fileInfo)==null?void 0:u.metadata)==null?void 0:E.height)&&e.jsxs(c,{size:"sm",c:"dimmed",children:["解像度: ",r.fileInfo.metadata.width,"×",r.fileInfo.metadata.height]}),((T=(O=r.fileInfo)==null?void 0:O.metadata)==null?void 0:T.duration)&&e.jsxs(c,{size:"sm",c:"dimmed",children:["再生時間: ",wt(r.fileInfo.metadata.duration)]})]}):null};return e.jsx(Re,{opened:t,onClose:M,title:B(),centered:!0,size:"xl",styles:{content:{maxWidth:"90vw"}},children:e.jsxs(J,{gap:"md",children:[i(),k(),e.jsx(De,{}),o(),!F&&D(),j()]})})},yt=t=>{const x=/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,s=t.match(x);return s?s[1]:null},jt=t=>({video:"動画",image:"画像",text:"テキスト","rich-text":"リッチテキスト",youtube:"YouTube",url:"URL"})[t]||t,bt=t=>{if(t===0)return"0 B";const x=1024,s=["B","KB","MB","GB"],f=Math.floor(Math.log(t)/Math.log(x));return`${Number.parseFloat((t/x**f).toFixed(1))} ${s[f]}`},wt=t=>{const x=Math.floor(t/3600),s=Math.floor(t%3600/60),f=Math.floor(t%60);return x>0?`${x}:${s.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`:`${s}:${f.toString().padStart(2,"0")}`},It=()=>{const{getPlaylistsIndex:t,getPlaylistById:x}=ze(),s=h.useCallback(async()=>{try{const g=new Set,S=await t();for(const I of S)try{const r=await x(I.id);if(!r)continue;for(const d of r.contentAssignments)for(const R of d.contentIds)g.add(R)}catch(r){V.warn("useUnusedContents",`Failed to load playlist ${I.id}`,r)}return g}catch(g){throw V.error("useUnusedContents","Failed to get used content IDs",g),new Error("使用中コンテンツの取得に失敗しました")}},[t,x]),f=h.useCallback(async g=>{try{const S=await s(),I=new Set;for(const r of g)S.has(r.id)||I.add(r.id);return I}catch(S){throw V.error("useUnusedContents","Failed to get unused content IDs",S),S}},[s]);return{getUsedContentIds:s,getUnusedContentIds:f}},Ct=t=>{switch(t){case"video":return e.jsx(Ee,{size:16});case"image":return e.jsx(Se,{size:16});case"text":return e.jsx(fe,{size:16});case"rich-text":return e.jsx(fe,{size:16});case"youtube":return e.jsx(Te,{size:16});case"url":return e.jsx(je,{size:16});default:return e.jsx(ye,{size:16})}},vt=t=>{const x={video:"blue",image:"green",text:"orange","rich-text":"teal",youtube:"red",url:"purple"},s={video:"動画",image:"画像",text:"テキスト","rich-text":"リッチテキスト",youtube:"YouTube",url:"URL"};return e.jsx(ie,{color:x[t],variant:"light",leftSection:Ct(t),children:s[t]})},Tt=t=>{if(!t)return"";if(t===0)return"0 B";const x=1024,s=["B","KB","MB","GB"],f=Math.floor(Math.log(t)/Math.log(x));return`${Number.parseFloat((t/x**f).toFixed(1))} ${s[f]}`},Gt=Ue(function(){const[x]=$(et),[s]=$(tt),[f]=$(rt),[g,S]=$(st),[I]=$(nt),[r]=$(it),[,d]=$(at),[,R]=$(ot),[_]=$(Ke),[,p]=$(Xe),{getContentsIndex:y,deleteContentSafely:F,checkContentUsageStatus:A,createFileOrTextContent:z,createUrlContent:C,createRichTextContent:l,updateContent:v,getContentById:U}=ue(),{getUnusedContentIds:M}=It(),k=h.useCallback(async n=>{try{const i=await M(n);d({type:"SET_UNUSED_CONTENT_IDS",unusedIds:i})}catch(i){V.error("Contents","Failed to refresh unused status",i)}},[M,d]);h.useEffect(()=>{(async()=>{d({type:"SET_LOADING",loading:!0}),d({type:"SET_ERROR",error:null});try{const i=await y();d({type:"SET_CONTENTS",contents:i});const o=await M(i);d({type:"SET_UNUSED_CONTENT_IDS",unusedIds:o})}catch(i){d({type:"SET_ERROR",error:i instanceof Error?i.message:"不明なエラーが発生しました"})}finally{d({type:"SET_LOADING",loading:!1})}})()},[y,M,d]);const B=async(n,i)=>{try{const o=await A(n);if(o.isUsed){ge.openConfirmModal({title:"削除できません",children:e.jsxs(w,{children:[e.jsx(c,{size:"sm",mb:"md",children:"このコンテンツは以下のプレイリストで使用されているため削除できません："}),e.jsx(w,{mb:"md",children:o.playlists.map(j=>e.jsx(ie,{variant:"light",color:"blue",size:"sm",mr:"xs",mb:"xs",children:j.name},j.id))}),e.jsx(c,{size:"sm",c:"dimmed",children:"削除するには、まずプレイリストからコンテンツを削除してください。"})]}),labels:{confirm:"OK",cancel:""},cancelProps:{display:"none"}});return}ge.openConfirmModal({title:"コンテンツを削除",children:e.jsxs(w,{children:[e.jsxs(c,{size:"sm",mb:"md",children:["「",i,"」を削除しますか？この操作は元に戻せません。"]}),e.jsx(pe,{icon:e.jsx(ve,{size:16}),color:"gray",children:"このコンテンツはどのプレイリストでも使用されていません。"})]}),labels:{confirm:"削除",cancel:"キャンセル"},confirmProps:{color:"red"},onConfirm:async()=>{try{await F(n),d({type:"REMOVE_CONTENT",id:n});const j=await y();await k(j)}catch(j){d({type:"SET_ERROR",error:j instanceof Error?j.message:"削除に失敗しました"})}}})}catch(o){d({type:"SET_ERROR",error:o instanceof Error?o.message:"使用状況の確認に失敗しました"})}},L=()=>{R({type:"OPEN_CONTENT_ADD"})},H=(n,i)=>{(i==="video"||i==="image"||i==="youtube"||i==="rich-text")&&p({type:"OPEN_CONTENT_PREVIEW",contentId:n})},K=async(n,i)=>{var o;try{for(let D=0;D<n.length;D++){const a=n[D],m=i==null?void 0:i[D],b=await z(a,m),u={id:b.id,name:b.name,type:b.type,size:(o=b.fileInfo)==null?void 0:o.size,tags:b.tags,createdAt:b.createdAt,updatedAt:b.updatedAt};d({type:"ADD_CONTENT",content:u})}const j=await y();await k(j)}catch(j){throw d({type:"SET_ERROR",error:j instanceof Error?j.message:"ファイルのアップロードに失敗しました"}),j}},Y=async n=>{var i;try{const o=await C(n.url,n.name,n.title,n.description),j={id:o.id,name:o.name,type:o.type,url:(i=o.urlInfo)==null?void 0:i.url,tags:o.tags,createdAt:o.createdAt,updatedAt:o.updatedAt};d({type:"ADD_CONTENT",content:j});const D=await y();await k(D)}catch(o){throw d({type:"SET_ERROR",error:o instanceof Error?o.message:"URLコンテンツの作成に失敗しました"}),o}},ee=async n=>{try{const i=await l(n.name,n.richTextInfo),o={id:i.id,name:i.name,type:i.type,tags:i.tags,createdAt:i.createdAt,updatedAt:i.updatedAt};d({type:"ADD_CONTENT",content:o});const j=await y();await k(j)}catch(i){throw d({type:"SET_ERROR",error:i instanceof Error?i.message:"リッチテキストコンテンツの作成に失敗しました"}),i}},Z=()=>{R({type:"CLOSE_CONTENT_ADD"})},te=async n=>{var i,o;try{const j={name:n.name,tags:n.tags,updatedAt:new Date().toISOString()};if(n.richTextInfo&&(j.richTextInfo=n.richTextInfo),n.urlInfo){const b=await U(n.id);b!=null&&b.urlInfo&&(j.urlInfo={...b.urlInfo,...n.urlInfo})}const D=await v(n.id,j),a={id:D.id,name:D.name,type:D.type,size:(i=D.fileInfo)==null?void 0:i.size,url:(o=D.urlInfo)==null?void 0:o.url,tags:D.tags,createdAt:D.createdAt,updatedAt:D.updatedAt};d({type:"UPDATE_CONTENT",id:n.id,content:a});const m=await y();await k(m),G()}catch(j){throw V.error("Contents","Content edit failed",j),d({type:"SET_ERROR",error:`コンテンツの編集に失敗しました: ${j}`}),j}},G=()=>{R({type:"CLOSE_CONTENT_EDIT"})};return e.jsxs(w,{pos:"relative",children:[e.jsx(Ve,{visible:s}),f&&!f.includes("Failed to read JSON")&&e.jsx(pe,{icon:e.jsx(ve,{size:16}),color:"red",mb:"md",children:f}),e.jsxs(P,{justify:"space-between",mb:"md",children:[e.jsx(ke,{}),e.jsxs(P,{gap:"sm",children:[e.jsxs(W.Group,{children:[e.jsx(W,{variant:g==="table"?"filled":"default",color:"blue",onClick:()=>S("table"),"aria-label":"テーブルビュー",children:e.jsx(Ne,{size:18})}),e.jsx(W,{variant:g==="grid"?"filled":"default",color:"blue",onClick:()=>S("grid"),"aria-label":"グリッドビュー",children:e.jsx(Ze,{size:18})})]}),e.jsx(W,{leftSection:e.jsx(qe,{size:16}),onClick:L,children:"コンテンツを追加"})]})]}),g==="table"?e.jsxs(N,{striped:!0,highlightOnHover:!0,children:[e.jsx(N.Thead,{children:e.jsxs(N.Tr,{children:[e.jsx(N.Th,{w:60,children:"編集"}),e.jsx(N.Th,{w:40}),e.jsx(N.Th,{children:"種別"}),e.jsx(N.Th,{children:"名前"}),e.jsx(N.Th,{children:"サイズ/URL"}),e.jsx(N.Th,{children:"作成日時"}),e.jsx(N.Th,{w:60,children:"操作"})]})}),e.jsx(N.Tbody,{children:x.length===0&&!s?e.jsx(N.Tr,{children:e.jsx(N.Td,{colSpan:7,ta:"center",c:"dimmed",children:"コンテンツがありません"})}):x.map(n=>{const i=n.type==="video"||n.type==="image"||n.type==="youtube"||n.type==="rich-text";return e.jsxs(N.Tr,{style:{cursor:i?"pointer":"default"},onClick:()=>H(n.id,n.type),children:[e.jsx(N.Td,{children:e.jsx(ne,{variant:"subtle",color:"blue",size:"sm",onClick:o=>{o.stopPropagation(),R({type:"OPEN_CONTENT_EDIT",content:n})},"aria-label":"編集",children:e.jsx(Ae,{size:16})})}),e.jsx(N.Td,{children:i&&e.jsx(ht,{content:n,children:e.jsx(ne,{variant:"subtle",color:"gray",size:"sm",onClick:o=>o.stopPropagation(),"aria-label":"プレビュー",children:e.jsx(Je,{size:16})})})}),e.jsx(N.Td,{children:vt(n.type)}),e.jsxs(N.Td,{children:[e.jsx(c,{fw:500,children:n.name}),n.tags.length>0&&e.jsx(P,{gap:4,mt:2,children:n.tags.map(o=>e.jsx(ie,{size:"xs",variant:"outline",children:o},o))})]}),e.jsx(N.Td,{children:n.size?e.jsx(c,{size:"sm",children:Tt(n.size)}):n.url?e.jsx(c,{size:"sm",maw:200,truncate:!0,children:n.url}):e.jsx(c,{size:"sm",c:"dimmed",children:"-"})}),e.jsx(N.Td,{children:e.jsx(c,{size:"sm",children:new Date(n.createdAt).toLocaleString("ja-JP")})}),e.jsx(N.Td,{children:e.jsx(ne,{variant:"subtle",color:"red",size:"sm",onClick:o=>{o.stopPropagation(),B(n.id,n.name)},"aria-label":"削除",children:e.jsx(Me,{size:16})})})]},n.id)})})]}):e.jsx(_e,{contents:x,loading:s,onContentClick:n=>{H(n.id,n.type)},onContentEdit:n=>{R({type:"OPEN_CONTENT_EDIT",content:n})},onContentDelete:n=>{B(n.id,n.name)}}),e.jsx($e,{opened:I,onClose:Z,onFileSubmit:K,onUrlSubmit:Y,onRichTextSubmit:ee}),e.jsx(gt,{opened:_.opened,onClose:()=>p({type:"CLOSE_CONTENT_PREVIEW"}),contentId:_.contentId,allContents:x,onContentDeleted:()=>{(async()=>{try{const i=await y();d({type:"SET_CONTENTS",contents:i});const o=await M(i);d({type:"SET_UNUSED_CONTENT_IDS",unusedIds:o})}catch(i){d({type:"SET_ERROR",error:i instanceof Error?i.message:"不明なエラーが発生しました"})}})()},onContentUpdated:()=>{(async()=>{try{const i=await y();d({type:"SET_CONTENTS",contents:i});const o=await M(i);d({type:"SET_UNUSED_CONTENT_IDS",unusedIds:o})}catch(i){d({type:"SET_ERROR",error:i instanceof Error?i.message:"不明なエラーが発生しました"})}})()},onContentChange:n=>{p({type:"OPEN_CONTENT_PREVIEW",contentId:n})}}),r.content&&e.jsx(Pe,{opened:r.opened,onClose:G,content:r.content,onSubmit:te})]})});export{Gt as default};
